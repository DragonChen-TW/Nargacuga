<!DOCTYPE html>
<html><script type="text/javascript" async="" src="ref_files/analytics.js"></script><script>(function(){class RuffleMimeType{constructor(a,b,c){this.type=a,this.description=b,this.suffixes=c}}class RuffleMimeTypeArray{constructor(a){this.__mimetypes=[],this.__named_mimetypes={};for(let b of a)this.install(b)}install(a){let b=this.__mimetypes.length;this.__mimetypes.push(a),this.__named_mimetypes[a.type]=a,this[a.type]=a,this[b]=a}item(a){return this.__mimetypes[a]}namedItem(a){return this.__named_mimetypes[a]}get length(){return this.__mimetypes.length}}class RufflePlugin extends RuffleMimeTypeArray{constructor(a,b,c,d){super(d),this.name=a,this.description=b,this.filename=c}install(a){a.enabledPlugin||(a.enabledPlugin=this),super.install(a)}}class RufflePluginArray{constructor(a){this.__plugins=[],this.__named_plugins={};for(let b of a)this.install(b)}install(a){let b=this.__plugins.length;this.__plugins.push(a),this.__named_plugins[a.name]=a,this[a.name]=a,this[b]=a}item(a){return this.__plugins[a]}namedItem(a){return this.__named_plugins[a]}refresh(){}get length(){return this.__plugins.length}}const FLASH_PLUGIN=new RufflePlugin("Shockwave Flash","Shockwave Flash 32.0 r0","ruffle.js",[new RuffleMimeType("application/futuresplash","Shockwave Flash","spl"),new RuffleMimeType("application/x-shockwave-flash","Shockwave Flash","swf"),new RuffleMimeType("application/x-shockwave-flash2-preview","Shockwave Flash","swf"),new RuffleMimeType("application/vnd.adobe.flash-movie","Shockwave Flash","swf")]);function install_plugin(a){navigator.plugins.install||Object.defineProperty(navigator,"plugins",{value:new RufflePluginArray(navigator.plugins),writable:!1}),navigator.plugins.install(a),0<a.length&&!navigator.mimeTypes.install&&Object.defineProperty(navigator,"mimeTypes",{value:new RuffleMimeTypeArray(navigator.mimeTypes),writable:!1});for(var b=0;b<a.length;b+=1)navigator.mimeTypes.install(a[b])}install_plugin(FLASH_PLUGIN);})();</script><script src="ref_files/ruffle.js"></script><head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>[原創] 使用Golang、Gin和React、Esbuild開發和Docker部署的一站式Blog</title>

    <link rel="shortcut icon" href="https://www.yuanliang.run/favicon.png">

    <link rel="stylesheet" href="ref_files/font-awesome.css">
    <link rel="stylesheet" type="text/css" href="ref_files/pharos.css">
    <link rel="stylesheet" type="text/css" href="ref_files/code.css">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="https://www.yuanliang.run/favicon.png" type="image/png">
    <link rel="canonical" href="https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/amp/">
    
    <meta property="og:site_name" content="Yuan Liang">
    <meta property="og:type" content="article">
    <meta property="og:title" content="[原创] 使用Golang、Gin和React、Esbuild开发和Docker部署的一站式Blog">
    <meta property="og:description" content="本指北手册，手把手跟大家从头开始构建一个完成一个Go作为服务的Web应用程序 — Blog 完整的应用程序 可以在 [github上下载 ]yuanliang/pharos · GitHub Go（Golang）是谷歌开发的一种开源语言，更多信息请访问 Go官网 Gin 是一个轻量级的高性能Web框架，支持现代Web应用程序所需的大叔叔基本特性和功能。更多信息、文档访问 &nbsp;Gin官网 React 是Facebook开发的JavaScript框架。React官网 Esbuild 是新一代的JavasScript打包工具 Esbuild官网 Typescript TypeScript 是一种由微软开发的自由和开源的编程语言，它是 JavaScript 的一个超集，扩展了 JavaScript 的语法。 TypeScript官网 PostgreSQL 是我们将用于存储数据的数据库，可以到 PostgreSQL官网查看了解更多信息。 相关安装都在官网有详细介绍就不在这里赘述了。 一、启动Gin服务首先，我们要给我们的Web应用程序取个名字，用作我们Blog程序的服务端。这里我用 Pharos（灯塔） cd ~/go/">
    <meta property="og:url" content="https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/">
    <meta property="og:image" content="https://www.yuanliang.run/content/images/2021/10/DSC_0489.jpg">
    <meta property="article:published_time" content="2021-12-07T10:33:03.000Z">
    <meta property="article:modified_time" content="2021-12-20T01:12:33.000Z">
    <meta property="article:publisher" content="https://www.facebook.com/iyuanliang">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="[原创] 使用Golang、Gin和React、Esbuild开发和Docker部署的一站式Blog">
    <meta name="twitter:description" content="本指北手册，手把手跟大家从头开始构建一个完成一个Go作为服务的Web应用程序 — Blog 完整的应用程序 可以在 [github上下载 ]yuanliang/pharos · GitHub Go（Golang）是谷歌开发的一种开源语言，更多信息请访问 Go官网 Gin 是一个轻量级的高性能Web框架，支持现代Web应用程序所需的大叔叔基本特性和功能。更多信息、文档访问 &nbsp;Gin官网 React 是Facebook开发的JavaScript框架。React官网 Esbuild 是新一代的JavasScript打包工具 Esbuild官网 Typescript TypeScript 是一种由微软开发的自由和开源的编程语言，它是 JavaScript 的一个超集，扩展了 JavaScript 的语法。 TypeScript官网 PostgreSQL 是我们将用于存储数据的数据库，可以到 PostgreSQL官网查看了解更多信息。 相关安装都在官网有详细介绍就不在这里赘述了。 一、启动Gin服务首先，我们要给我们的Web应用程序取个名字，用作我们Blog程序的服务端。这里我用 Pharos（灯塔） cd ~/go/">
    <meta name="twitter:url" content="https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/">
    <meta name="twitter:image" content="https://www.yuanliang.run/content/images/2021/10/DSC_0489.jpg">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Yuan Liang">
    <meta name="twitter:site" content="@yuanliang">
    <meta name="twitter:creator" content="@yuanliang">
    <meta property="og:image:width" content="4288">
    <meta property="og:image:height" content="2848">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Yuan Liang",
        "url": "https://www.yuanliang.run/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.yuanliang.run/favicon.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Yuan Liang",
        "url": "https://www.yuanliang.run/author/yuanliang/",
        "sameAs": [
            "https://twitter.com/yuanliang"
        ]
    },
    "headline": "[原创] 使用Golang、Gin和React、Esbuild开发和Docker部署的一站式Blog",
    "url": "https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/",
    "datePublished": "2021-12-07T10:33:03.000Z",
    "dateModified": "2021-12-20T01:12:33.000Z",
    "description": "\n本指北手册，手把手跟大家从头开始构建一个完成一个Go作为服务的Web应用程序 — Blog\n\n完整的应用程序 可以在 [github上下载 ]yuanliang/pharos · GitHub\n[https://github.com/yuanliang/pharos]\n\nGo（Golang）是谷歌开发的一种开源语言，更多信息请访问 Go官网 [https://dev.to]\n\nGin 是一个轻量级的高性能Web框架，支持现代Web应用程序所需的大叔叔基本特性和功能。更多信息、文档访问Gin官网\n[https://gin-gonic.com]\n\nReact 是Facebook开发的JavaScript框架。React官网 [https://reactjs.org]\n\nEsbuild 是新一代的JavasScript打包工具 Esbuild官网 [https://esbuild.github.io/api/]\n\nTypescript TypeScript 是一种由微软开发的自由和开源的编程语言，它是 JavaScript 的一个超集，扩展了 JavaScript\n的语法。 TypeScr",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.yuanliang.run/"
    }
}
    </script>

    <meta name="generator" content="Ghost 4.25">
    <link rel="alternate" type="application/rss+xml" title="Yuan Liang" href="https://www.yuanliang.run/rss/">
    
    <script async="" src="ref_files/cards.js"></script><style>:root {--ghost-accent-color: #FF1A75;}</style>
    <link rel="stylesheet" type="text/css" href="ref_files/cards.css">

    <style>
        .preload {
            position: absolute;
            display: table;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: #fff;
            z-index: 1000;
            -webkit-transition: .2s cubic-bezier(.645, .045, .355, 1);
               -moz-transition: .2s cubic-bezier(.645, .045, .355, 1);
                 -o-transition: .2s cubic-bezier(.645, .045, .355, 1);
                    transition: .2s cubic-bezier(.645, .045, .355, 1);
        }

        .preload.fade {
            opacity: 0;
            z-index: -1000
        }
	.icp {
		position: absolute;
		right: 6.5%;
		bottom:3.5rem;
		width: 169px;
	}
	.icp a {
		font-size: 10px;
		color: #f8f8f8;
		margin: 10px 10%;
	}
	.douban-show img {
		margin-right: 15px;
	}
    </style>
<script type="text/javascript" async="" src="ref_files/embed.js"></script><style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style><link rel="prefetch" as="style" href="ref_files/a_data_002/lounge.css"><link rel="prefetch" as="script" href="ref_files/a_data_002/common.js"><link rel="prefetch" as="script" href="ref_files/a_data_002/lounge.js"><link rel="prefetch" as="script" href="ref_files/a_data_002/config.js"><script src="ref_files/alfie_v4.js" async="" charset="UTF-8"></script></head>
<body class="post-template" data-new-gr-c-s-check-loaded="8.898.0" data-gr-ext-installed="" data-new-gr-c-s-loaded="8.898.0">

    <div class="preload fade"></div>

    <span class="toggle-navigation"></span>

<nav class="navigation">
	<ul>
	    <li class="nav-home " role="presentation">
	        <a href="https://www.yuanliang.run/">Home</a>
	    </li>
	    <li class="nav-douban " role="presentation">
	        <a href="https://www.yuanliang.run/douban/">Douban</a>
	    </li>
	    <li class="nav-resume " role="presentation">
	        <a href="https://www.yuanliang.run/resume/">Resume</a>
	    </li>
	    <li class="nav-about " role="presentation">
	        <a href="https://www.yuanliang.run/about/">About</a>
	    </li>
	    
	</ul>
</nav>

	

<aside class="cover" style="width: 25%; background: linear-gradient( rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.15) ), url(https://www.yuanliang.run/content/images/2021/10/DSC_0489.jpg);">	
	<div class="cover-content">
		<div class="container">
			<h1 class="cover-headline">[原創] 使用Golang、Gin和React、Esbuild開發和Docker部署的一站式Blog</h1>
			<p class="cover-text"></p>
		</div>		
	</div>
	<div class="cover-text-article-time">
        <div class="container">
            <strong>
                <time datetime="2021-12-07" itemprop="datePublished">
                    December 07,  2021	
                </time>
            </strong>	
        </div>	    	
	</div>
</aside>

<main class="content" style="width: 75%;">
    <article class="article-content" role="article" itemscope="" itemtype="//schema.org/Article">
        <div class="container">
            <div class="social-sharing-bar">
	<a class="button share-facebook" target="_blank" title="Share over Facebook" href="https://www.facebook.com/sharer.php?u=https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/"><i class="fa fa-facebook"></i></a>

	<a class="button share-twitter" target="_blank" title="Share over Twitter" href="https://twitter.com/share?text=[%E5%8E%9F%E5%88%9B]%20%E4%BD%BF%E7%94%A8Golang%E3%80%81Gin%E5%92%8CReact%E3%80%81Esbuild%E5%BC%80%E5%8F%91%E5%92%8CDocker%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E7%AB%99%E5%BC%8FBlog&amp;url=https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/"><i class="fa fa-twitter"></i></a>

	<a class="button share-weibo" target="_blank" title="分享到微博" href="https://service.weibo.com/share/share.php?url=https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/&amp;title=[%E5%8E%9F%E5%88%9B]%20%E4%BD%BF%E7%94%A8Golang%E3%80%81Gin%E5%92%8CReact%E3%80%81Esbuild%E5%BC%80%E5%8F%91%E5%92%8CDocker%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E7%AB%99%E5%BC%8FBlog"><i class="fa fa-weibo"></i></a>

	<a class="button share-qq" target="_blank" title="分享到QQ" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/"><i class="fa fa-qq"></i></a>

	<button class="toggle-comments"><span>Comments</span> <i class="fa fa-comments-o"></i></button>
</div>
            <h1></h1><p>本指北手冊，手把手跟大家從頭開始構建一個完成一個Go作為服務的Web應用程序 — Blog</p><p>完整的應用程序 可以在 [github上下載 ]<a href="https://github.com/yuanliang/pharos">yuanliang/pharos · GitHub</a></p><p><strong>Go</strong>（Golang）是谷歌開發的一種開源語言，更多信息請訪問 <a href="https://dev.to/">Go官網</a></p><p><strong>Gin</strong> 是一個輕量級的高性能Web框架，支持現代Web應用程序所需的大叔叔基本特性和功能。更多信息、文檔訪問 &nbsp;<a href="https://gin-gonic.com/">Gin官網</a></p><p><strong>React</strong> 是Facebook開發的JavaScript框架。<a href="https://reactjs.org/">React官網</a></p><p><strong>Esbuild</strong> 是新一代的JavasScript打包工具 <a href="https://esbuild.github.io/api/">Esbuild官網</a></p><p><strong>Typescript</strong> TypeScript 是一種由微軟開發的自由和開源的編程語言，它是 JavaScript 的一個超集，擴展了 JavaScript 的語法。 <a href="https://www.typescriptlang.org/">TypeScript官網</a></p><p><strong>PostgreSQL</strong> 是我們將用於存儲數據的數據庫，可以到 <a href="https://www.postgresql.org/">PostgreSQL官網</a>查看瞭解更多信息。</p><p>相關安裝都在官網有詳細介紹就不在這裡贅述了。</p><h1 id="%E4%B8%80%E3%80%81%E5%90%AF%E5%8A%A8gin%E6%9C%8D%E5%8A%A1">一、啟動Gin服務</h1><p>首先，我們要給我們的Web應用程序取個名字，用作我們Blog程序的服務端。這裡我用 Pharos（燈塔）</p><pre class=" language-bash"><code class=" language-bash">cd ~/go/src
mkdir pharos
cd pharos
</code></pre><p>如果還沒有安裝依賴可以 &nbsp;通過下面命令來下載安裝它。</p><pre class=" language-shell"><code class=" language-shell">go mod download <a class="vglnk" href="http://github.com/gin-gonic/gin" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>gin</span><span>-</span><span>gonic</span><span>/</span><span>gin</span></a>
</code></pre><p>在編寫我們的第一個後端源文件之前，我們需要在Golang所需的項目根目錄中創建<code>go.mod</code> 文件，以查找和導入所需要的依賴。該文件的內容為：</p><pre class=" language-shell"><code class=" language-shell">module pharos

go 1.17

require <a class="vglnk" href="http://github.com/gin-gonic/gin" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>gin</span><span>-</span><span>gonic</span><span>/</span><span>gin</span></a> v1.7.7
</code></pre><p>通過如下命令來整理一下go.mod文件</p><pre class=" language-shell"><code class=" language-shell">go mod tidy
</code></pre><p>現在，創建一個入口文件 <code>main.go</code> &nbsp;:</p><pre class=" language-go"><code class=" language-go">
<span class="token keyword keyword-package">package</span> main

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"<a class="vglnk" href="http://github.com/gin-gonic/gin" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>gin</span><span>-</span><span>gonic</span><span>/</span><span>gin</span></a>"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 創建默認的 gin 路由器，並且已經附加了 Logger 和 Recovery 中間件</span>
  router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// 創建 API 路由組</span>
  api <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/api"</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 將 /hello GET 路由添加到路由器並定義路由處理程序</span>
		api<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">,</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"world"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  router<span class="token punctuation">.</span><span class="token function">NoRoute</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// 開始監聽服務請求</span>
  router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><p>現在我們可以通過如下命令來啟動服務器：</p><pre class=" language-shell"><code class=" language-shell">
go run main.go

</code></pre><p>然後可以打開瀏覽器輸入 &nbsp;<code><a class="vglnk" href="http://localhost:8080/api/hello" rel="nofollow"><span>http</span><span>://</span><span>localhost</span><span>:</span><span>8080</span><span>/</span><span>api</span><span>/</span><span>hello</span></a></code> 來驗證服務是否正常啟動。如果正常您講看到 <code>{"msg":"world"}</code></p><figure class="kg-card kg-image-card"><img src="ref_files/4353110cf86e4710bd615671b0c5f11etplv-k3u1fbpfcp-watermark.png" class="kg-image" alt="Screen Shot 2021-12-06 at 7.57.09 PM.png" loading="lazy"></figure><p>可以在命令行工具裡面看到訪問情況。</p><h1 id="%E4%BA%8C%E3%80%81%E6%B7%BB%E5%8A%A0react">二、添加React</h1><p>有了後端服務，現在可以添加前端框架。我們使用 <code>esbuild-create-react-app</code> 來安裝react框架</p><p>現在根目錄下安裝React</p><pre class=" language-shell"><code class=" language-shell">
npx esbuild-create-react-app app
cd app
yarn start | npm run start

</code></pre><p>過程中您會看到語言的選擇，請選擇Typescript。</p><pre class=" language-shell"><code class=" language-shell">
            W  E  L  C  O  M  E      T  O         

      .d88b.  .d8888b       .d8888b 888d888 8888b.  
     d8P  Y8b 88K          d88P"    888P"      "88b 
     88888888 "Y8888b.     888      888    .d888888 
     Y8b.          X88     Y88b.    888    888  888 
      "Y8888   88888P'      "Y8888P 888    "Y888888 
                                                    
     
Hello there! esbuild create react app is a minimal replacement for create react app using a truly blazing fast esbuild bundler.
Up and running in less than 1 minute with almost zero configuration needed.
     
? To get started please choose a template 
  Javascript 
❯ Typescript 

</code></pre><p>安裝完成後，我們需要進入 site 中 打開 <code>package.json</code> 文件， 在當中增加 <code>”proxy”: “<a class="vglnk" href="http://localhost:8080”" rel="nofollow"><span>http</span><span>://</span><span>localhost</span><span>:</span><span>8080</span><span>”</span></a></code> &nbsp;。 這個會將React開發的服務將我們所有的請求代理到Gin後端，Gin後端將在端口8080上監聽。</p><pre class=" language-shell"><code class=" language-shell">
{
  "name": "site",
  "version": "1.0.0",
  "main": "builder.js",
  "author": "Yuan Liang",
  "license": "MIT",
  "proxy": "<a class="vglnk" href="http://localhost:8080/" rel="nofollow"><span>http</span><span>://</span><span>localhost</span><span>:</span><span>8080</span></a>",
  "scripts": {
    "pre-commit": "lint-staged",
    "lint": "eslint \"src/**/*.{ts,tsx}\" --max-warnings=0",
    "start": "node builder.js",
    "build": "NODE_ENV=production node builder.js"
  },
  "dependencies": {
    "fs-extra": "^10.0.0",
    "react": "^17.0.2",
    "react-dom": "^17.0.2"
  },
  "devDependencies": {
    "@types/node": "^16.9.1",
    "@types/react": "^17.0.20",
    "@types/react-dom": "^17.0.9",
    "@typescript-eslint/eslint-plugin": "^4.31.0",
    "@typescript-eslint/parser": "^4.31.0",
    "chokidar": "^3.5.2",
    "esbuild": "^0.12.26",
    "eslint": "^7.32.0",
    "eslint-config-airbnb": "^18.2.1",
    "eslint-config-prettier": "^8.3.0",
    "eslint-plugin-import": "^2.24.2",
    "eslint-plugin-jsx-a11y": "^6.4.1",
    "eslint-plugin-react": "^7.25.1",
    "eslint-plugin-react-hooks": "^4.2.0",
    "husky": "^7.0.2",
    "lint-staged": "^11.1.2",
    "prettier": "^2.4.0",
    "server-reload": "^0.0.3",
    "typescript": "^4.4.3"
  },
  "lint-staged": {
    "*.+(js|jsx)": "eslint --fix",
    "*.+(json|css|md)": "prettier --write"
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  }
}


</code></pre><p>另外 live-server 裡面的 proxy 裡面有一些 bug 重新搞了一個包 ( <a href="https://github.com/yuanliang/server-reload">server-reload</a> ) ，增加了 POST method 的支持 還有 proxy的傳參方式。</p><pre class=" language-shell"><code class=" language-shell">
npm install server-reload --save-dev

</code></pre><p>所以 builder.js 的傳參也進行了修改。</p><pre class=" language-shell"><code class=" language-shell">
const serverParams = {
  port: 8181, // Set the server port. Defaults to 8080.
  root: 'dist', // Set root directory that's being served. Defaults to cwd.
  open: false, // When false, it won't load your browser by default.
  cors: true,
  // host: '0.0.0.0', // Set the address to bind to. Defaults to 0.0.0.0 or process.env.IP.
  proxy: {
    path: '/api',
    target: '<a class="vglnk" href="http://localhost:8080/api" rel="nofollow"><span>http</span><span>://</span><span>localhost</span><span>:</span><span>8080</span><span>/</span><span>api</span></a>'
  } // Set proxy URLs.
  // ignore: 'scss,my/templates', // comma-separated string for paths to ignore
  // file: 'index.html' // When set, serve this file (server root relative) for every 404 (useful for single-page applications)
  // wait: 1000, // Waits for all changes, before reloading. Defaults to 0 sec.
  // mount: [['/components', './node_modules']], // Mount a directory to a route.
  // logLevel: 2, // 0 = errors only, 1 = some, 2 = lots
  // middleware: [function(req, res, next) { next(); }] // Takes an array of Connect-compatible middleware that are injected into the server middleware stack
}
//

</code></pre><p>然後 <code>site</code> 文件裡面可以執行 <code>yarn start | npm run start</code> 項目啟動可以看到 Go 服務的數據已經返回。</p><figure class="kg-card kg-image-card"><img src="ref_files/ec4a5734473f4ca4832457e54b7a3d0dtplv-k3u1fbpfcp-watermark.png" class="kg-image" alt="Screen Shot 2021-12-07 at 6.28.21 PM.png" loading="lazy"></figure><figure class="kg-card kg-image-card"><img src="ref_files/37ee759e3e0a4d288b6fdc28699eb63btplv-k3u1fbpfcp-watermark.png" class="kg-image" alt="Screen Shot 2021-12-07 at 6.27.07 PM.png" loading="lazy"></figure><h1 id="%E4%B8%89%E3%80%81%E6%95%B4%E7%90%86%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%92%8C%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1">三、整理目錄結構和添加路由</h1><p>現在我們來重新規劃目錄結構，感覺比較正規一丟丟。 代碼按照功能來區分是一個比較好的最佳實踐。</p><p>我們現在創建一個 <code>services</code> 來放置我們的 go 服務應用文件 並在其中添加一個 <code>server</code> 文件夾當中放置 &nbsp;<code>server.go</code> 文件作為Gin的啟動文件。 然後在 <code>server</code> 文件中添加一個 <code>router.go</code> 來作為項目的路由管理文件。</p><p><code>main.go</code> 文件修改為</p><pre class=" language-go"><code class=" language-go">
<span class="token keyword keyword-package">package</span> main

<span class="token keyword keyword-import">import</span> <span class="token string">"pharos/services/server"</span>

<span class="token keyword keyword-func">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><p>調整後的目錄結構是這樣的</p><figure class="kg-card kg-image-card"><img src="ref_files/bf0d72322890445893d6fde3e3c3d635tplv-k3u1fbpfcp-watermark.png" class="kg-image" alt="d90bce43-14ac-478e-be3c-69bf884944de.png" loading="lazy"></figure><p>現在再次啟動一次服務看看效果：）</p><h1 id="%E5%9B%9B%E3%80%81%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%AF%B9%E8%B1%A1%E4%BB%A5%E5%8F%8A%E7%99%BB%E9%99%86%E6%B3%A8%E5%86%8C%E6%96%B9%E6%B3%95">四、創建用戶對象以及登陸注冊方法</h1><p>接下來作為博客程序，要做的第一件事就是來做用戶的創建登陸管理。現在我們來製作一個簡單的 <code>User</code> 對象放到文件運行在內存中，稍後我們將鏈接數據庫，可以方便的管理儲存數據。</p><p>第一步 讓我們在 <code>services</code> 當中來創建一個新目錄，我們將其命名為 <code>store</code>。 這個文件當中將保存我們這個blog的所有的數據邏輯。在我們將程序鏈接到數據哭之前，我們將用簡單的對象來儲存用戶。 在 <code>services/store</code> 目錄中，我們來創建一個新文件 <code>users.go</code></p><pre class=" language-go"><code class=" language-go">
<span class="token keyword keyword-package">package</span> store

<span class="token keyword keyword-type">type</span> User <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	Username <span class="token builtin">string</span>
	Password <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-var">var</span> Users <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User

</code></pre><p>接下來我們在 <code>router.go</code> 當中刪除 <code>/hello</code> 路由，換上新的路由 <code>/signup</code> 和 <code>/signin</code> 注冊和登錄</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Creates default gin router with Logger and Recovery middleware already attached</span>
  router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Enables automatic redirection if the current route can’t be matched but a</span>
  <span class="token comment" spellcheck="true">// handler for the path with (without) the trailing slash exists.</span>
  router<span class="token punctuation">.</span>RedirectTrailingSlash <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment" spellcheck="true">// Create API route group</span>
  api <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>api”<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signup”<span class="token punctuation">,</span> signUp<span class="token punctuation">)</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signin”<span class="token punctuation">,</span> signIn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  router<span class="token punctuation">.</span><span class="token function">NoRoute</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> router
<span class="token punctuation">}</span>
</code></pre><p>會發現 缺少 <code>signUp</code> 還有 <code>signIn</code> 兩個方法的實現 我們把這兩個方法的實現放到 &nbsp;<code>services/server/user.go</code> 當中</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “net<span class="token operator">/</span>http”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">signUp</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“err”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  store<span class="token punctuation">.</span>Users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>Users<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span> “Signed up successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “jwt”<span class="token punctuation">:</span> “<span class="token number">123456789</span>”<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">signIn</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“err”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> store<span class="token punctuation">.</span>Users <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> u<span class="token punctuation">.</span>Username <span class="token operator">==</span> user<span class="token punctuation">.</span>Username <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>Password <span class="token operator">==</span> user<span class="token punctuation">.</span>Password <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
        “msg”<span class="token punctuation">:</span> “Signed in successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
        “jwt”<span class="token punctuation">:</span> “<span class="token number">123456789</span>”<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword keyword-return">return</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“err”<span class="token punctuation">:</span> “Sign in failed<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>這段代碼的作用是。我們創建一個新的用戶類型變量，然後將用戶變量存儲在前端當中，然後我們調用 <code>bind()</code> 方法將數據綁定到 <code>User</code> 類型變量，如果綁定失敗，我們立即設置錯誤代碼和錯誤消息，並從當前函數返回。如果沒有錯誤，我們將響應代碼設置狀態為 OK 並返回 JWT 進行身份驗證。現在您可以不用關心 JWT 是啥，稍後會詳細介紹，也可能不會介紹自行搜索。</p><p>現在您可以重啟服務然後調用一下兩個路由的狀態 ，注意是 <code>POST</code>請求 需要專門的工具調試 ，或者暫不調試繼續往下。</p><figure class="kg-card kg-image-card"><img src="ref_files/524ad22fc72e4d74bb0633bda397ada0tplv-k3u1fbpfcp-watermark" class="kg-image" alt="1C23012A-7952-44F1-BA6E-6A18E82E95C5.png" loading="lazy"></figure><figure class="kg-card kg-image-card"><img src="ref_files/05b4101a1aa94bc18d353f8da66a1587tplv-k3u1fbpfcp-watermark.png" class="kg-image" alt="F44D09A5-9A76-4E56-8E5F-4567A2EF9B25.png" loading="lazy"></figure><p>接下來是填寫React的相關前端的頁面 可以直接到github上去下載</p><p>有了前端頁面就可以利用表單來注冊，登陸用戶了。在 <code>app/src/components/Auth/AuthForm.tsx</code> 當中為我們的表單提交增加一個 <code>submitHandler()</code> 方法。然後點擊提交後就可以看到提交的數據了 。</p><figure class="kg-card kg-image-card"><img src="ref_files/5cfa02a7a2ba4df094eebfc18f6c86ddtplv-k3u1fbpfcp-watermark.png" class="kg-image" alt="Screen Shot 2021-12-08 at 4.23.19 PM.png" loading="lazy"></figure><p>我們還需要給表單增加前後端的驗證規則，這裡主要來添加服務端的驗證。打開 <code>services/store/users.go</code> &nbsp;文件修改成如下這樣。</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-type">type</span> User <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  Username <span class="token builtin">string</span> <span class="token string">`binding:"required,min=5,max=30"`</span>
  Password <span class="token builtin">string</span> <span class="token string">`binding:"required,min=7,max=32"`</span>
<span class="token punctuation">}</span>
</code></pre><p>這裡接受設置了接手的字段和字段的規則 在這裡來找 Go 相關的驗證規則 <a href="https://github.com/go-playground/validator">go-playground/validator</a> &nbsp; 驗證支持的字段 <a href="https://pkg.go.dev/github.com/go-playground/validator#hdr-Baked_In_Validators_and_Tags">點擊這裡</a></p><p>現在可以通過注冊頁面輸入用戶名和密碼（重啟Gin服務），不符合規則的會返回服務端錯誤。</p><figure class="kg-card kg-image-card"><img src="ref_files/a62754b5b7d0463497b3dfc18668e02atplv-k3u1fbpfcp-watermark.png" class="kg-image" alt="Screen Shot 2021-12-08 at 4.23.19 PM.png" loading="lazy"></figure><h1 id="%E4%BA%94%E3%80%81%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE%E5%BA%93">五、添加數據庫</h1><p>目前為止我們的應用程序運行OK，我麼可以創建用戶，並且登陸但是我們一旦重啟Gin服務，我們的用戶數據就會丟失，因為他僅僅在內存中運行。一個完整的應用程序是需要數據庫來進行數據的存儲的，我們將所有的數據保存到數據庫中。 <code>PostgreSQL</code> 的具體安裝細節我們不做講解，官網上會有詳細的安裝步驟，我們現在假設您已經安裝和配置了 <code>PostgreSQL</code> 所有例子當中我們使用 postgres 默認的帳號和密碼。</p><p>首先我們創建一個數據庫，如果 <code>PostgreSQL</code> 沒有運行，我們需要啟動它，然後通過默認的帳號 postgres 來登陸。</p><pre class=" language-shell"><code class=" language-shell">sudo service postgresql start
sudo -u postgres psql
</code></pre><p>鏈接成功後 可以創建 數據庫</p><pre class=" language-shell"><code class=" language-shell">CREATE DATABASE pharos;
</code></pre><p>數據庫通信我們使用 <a href="https://github.com/go-pg/pg/">go-pg module</a>。您可以通過 &nbsp;<code>go get <a class="vglnk" href="http://github.com/go-pg/pg/v10" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>go</span><span>-</span><span>pg</span><span>/</span><span>pg</span><span>/</span><span>v10</span></a></code> 命令來進行安裝。 現在我們在 <code>services</code> 文件夾當中新增加一個新的目錄文件 <code>database</code> 並且新增一個文件 <code>database.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> database

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"<a class="vglnk" href="http://github.com/go-pg/pg/v10" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>go</span><span>-</span><span>pg</span><span>/</span><span>pg</span><span>/</span><span>v10</span></a>"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">NewDBOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>pg<span class="token punctuation">.</span>Options <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token operator">&amp;</span>pg<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
    Addr<span class="token punctuation">:</span>     <span class="token string">"localhost:5432"</span><span class="token punctuation">,</span>
    Database<span class="token punctuation">:</span> <span class="token string">"pharos"</span><span class="token punctuation">,</span>
    User<span class="token punctuation">:</span>     <span class="token string">"postgres"</span><span class="token punctuation">,</span>
    Password<span class="token punctuation">:</span> <span class="token string">"postgres"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>然後在 &nbsp;<code>services/store/store.go</code> 增加數據庫的連接。</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> store

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “log”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword keyword-go">go</span><span class="token operator">-</span>pg<span class="token operator">/</span>pg<span class="token operator">/</span>v10”
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// Database connector</span>
<span class="token keyword keyword-var">var</span> db <span class="token operator">*</span>pg<span class="token punctuation">.</span>DB

<span class="token keyword keyword-func">func</span> <span class="token function">SetDBConnection</span><span class="token punctuation">(</span>dbOpts <span class="token operator">*</span>pg<span class="token punctuation">.</span>Options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-if">if</span> dbOpts <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panicln</span><span class="token punctuation">(</span>“DB options can’t be <span class="token boolean">nil</span>”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
    db <span class="token operator">=</span> pg<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>dbOpts<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">GetDBConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>pg<span class="token punctuation">.</span>DB <span class="token punctuation">{</span> <span class="token keyword keyword-return">return</span> db <span class="token punctuation">}</span>
</code></pre><p>創建一個變量db，然後創建兩個方法 Get and Set 數據庫連接方法 然後通過 <code>pg.Connect</code> 來連接數據庫。 然後我們回到 &nbsp;<code>services/server/server.go</code> &nbsp;增加項目啟動後的數據庫連接訪問</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>database”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  router <span class="token operator">:=</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Start listening and serving requests</span>
  router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>“<span class="token punctuation">:</span><span class="token number">8080</span>”<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>鏈接數據庫後，用戶的信息就可以保存到數據庫當中了，並且可以驗證一下登陸用戶名 密碼匹配。<code>services/store/users.go</code> 增加驗證相關能力。</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> store

<span class="token keyword keyword-import">import</span> “errors”

<span class="token keyword keyword-type">type</span> User <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  ID       <span class="token builtin">int</span>
  Username <span class="token builtin">string</span> <span class="token string">`binding:"required,min=5,max=30"`</span>
  Password <span class="token builtin">string</span> <span class="token string">`binding:"required,min=7,max=32"`</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">AddUser</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Returning</span><span class="token punctuation">(</span>“<span class="token operator">*</span>”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">Authenticate</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>
    “username <span class="token operator">=</span> ?”<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> password <span class="token operator">!=</span> user<span class="token punctuation">.</span>Password <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>“Password not valid<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> user<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><p>相應的 <code>services/server/user.go</code> 也需要進行相關的修改。</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “net<span class="token operator">/</span>http”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">signUp</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">AddUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span> “Signed up successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “jwt”<span class="token punctuation">:</span> “<span class="token number">123456789</span>”<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">signIn</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">Authenticate</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Sign in failed<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>

  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span> “Signed in successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “jwt”<span class="token punctuation">:</span> “<span class="token number">123456789</span>”<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>數據庫連接創建後，我們還需要創建表來存儲數據。我們使用 <code>go-pg/migrations</code> 模塊來做數據遷移。在Github上您可以找到安裝和使用指南這裡不做贅述。然後我們在根目錄創建一個文件夾 <code>migrations</code> 並在裡面創建一個文件 <code>main.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> main

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
	<span class="token string">"flag"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>

	<span class="token string">"pharos/services/database"</span>
	<span class="token string">"pharos/services/store"</span>

	<span class="token string">"<a class="vglnk" href="http://github.com/go-pg/migrations/v8" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>go</span><span>-</span><span>pg</span><span>/</span><span>migrations</span><span>/</span><span>v8</span></a>"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-const">const</span> usageText <span class="token operator">=</span> <span class="token string">`This program runs command on the db. Supported commands are:
  - init - creates version info table in the database
  - up - runs all available migrations.
  - up [target] - runs available migrations up to the target one.
  - down - reverts last migration.
  - reset - reverts all migrations.
  - version - prints current db version.
  - set_version [version] - sets db version without running migrations.
Usage:
  go run *.go &lt;command&gt; [args]
`</span>

<span class="token keyword keyword-func">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>Usage <span class="token operator">=</span> usage
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	db <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">GetDBConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	oldVersion<span class="token punctuation">,</span> newVersion<span class="token punctuation">,</span> err <span class="token operator">:=</span> migrations<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> flag<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">exitf</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-if">if</span> newVersion <span class="token operator">!=</span> oldVersion <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"migrated from version %d to %d\n"</span><span class="token punctuation">,</span> oldVersion<span class="token punctuation">,</span> newVersion<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"version is %d\n"</span><span class="token punctuation">,</span> oldVersion<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>usageText<span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">PrintDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">errorf</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword keyword-interface">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> s<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">exitf</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword keyword-interface">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">errorf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
	os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>這裡新增一個文件 <code>1_addUsersTable.go</code> 這個與<a href="https://github.com/go-pg/migrations/blob/v8/example/main.go">官方的例子</a>類似。我們可以用 <code>SetDBConnection()</code> 和 <code>GetDBConnection()</code> 在數據存儲包中來定義函數。這是運行數據遷移的主要入口。</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> main

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “fmt”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword keyword-go">go</span><span class="token operator">-</span>pg<span class="token operator">/</span>migrations<span class="token operator">/</span>v8”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  migrations<span class="token punctuation">.</span><span class="token function">MustRegisterTx</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>db migrations<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>“creating table users…”<span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">`CREATE TABLE users(
      id SERIAL PRIMARY KEY,
      username TEXT NOT NULL UNIQUE,
      password TEXT NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      modified_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    )`</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>db migrations<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>“dropping table users…”<span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">`DROP TABLE users`</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>然後進入 <code>migrations</code> 文件夾來執行相關命令</p><pre class=" language-shell"><code class=" language-shell">cd migrations/
go run *.go init
go run *.go up
</code></pre><p>我們將會為表格創建一個 users 用戶表，我們在數據庫中添加了 created_at 和 modified_at 列，因此我們還需要將它們添加到 <code>services/store/users.go</code> 中的User數據結構定義當中</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-type">type</span> User <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  ID         <span class="token builtin">int</span>
  Username   <span class="token builtin">string</span> <span class="token string">`binding:"required,min=5,max=30"`</span>
  Password   <span class="token builtin">string</span> <span class="token string">`binding:"required,min=7,max=32"`</span>
  CreatedAt  time<span class="token punctuation">.</span>Time
  ModifiedAt time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre><p>現在試著創建一個全新的帳號<br>然後我們去數據庫中觀察這個帳號已經被存儲到數據庫當中。<br>也可以創建一個遷移可執行文件</p><pre class=" language-go"><code class=" language-go">cd migrations<span class="token operator">/</span>
<span class="token keyword keyword-go">go</span> build <span class="token operator">-</span>o migrations <span class="token operator">*</span><span class="token punctuation">.</span><span class="token keyword keyword-go">go</span>
</code></pre><p>並且運行它</p><pre class=" language-shell"><code class=" language-shell">cd migrations/
go build -o migrations *.go
</code></pre><p>這裡有一個問題，users 表當中我們用純文本形式存儲用戶密碼，這種事不安全的，我們應該用一個隨機的種子來生成密碼，為此我們用 <a href="https://github.com/golang/crypto"><code>golan/crypto</code></a>庫，來擴展我們的用戶對象結構。</p><pre class=" language-go"><code class=" language-go"> <span class="token keyword keyword-type">type</span> User <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  ID             <span class="token builtin">int</span>
  Username       <span class="token builtin">string</span> <span class="token string">`binding:"required,min=5,max=30"`</span>
  Password       <span class="token builtin">string</span> <span class="token string">`pg:"-" binding:"required,min=7,max=32"`</span>
  HashedPassword <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token string">`json:"-"`</span>
  Salt           <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token string">`json:"-"`</span>
  CreatedAt      time<span class="token punctuation">.</span>Time
  ModifiedAt     time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre><p>修改 <code>migration</code> 文件</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> main

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “fmt”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword keyword-go">go</span><span class="token operator">-</span>pg<span class="token operator">/</span>migrations<span class="token operator">/</span>v8”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  migrations<span class="token punctuation">.</span><span class="token function">MustRegisterTx</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>db migrations<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>“creating table users…”<span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">`CREATE TABLE users(
      id SERIAL PRIMARY KEY,
      username TEXT NOT NULL UNIQUE,
      hashed_password BYTEA NOT NULL,
      salt BYTEA NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
      modified_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
    )`</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>db migrations<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>“dropping table users…”<span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">`DROP TABLE users`</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>現在再修改一下 <code>services/store/users.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> store

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"crypto/rand"</span>
  <span class="token string">"time"</span>

  <span class="token string">"<a class="vglnk" href="http://golang.org/x/crypto/bcrypt" rel="nofollow"><span>golang</span><span>.</span><span>org</span><span>/</span><span>x</span><span>/</span><span>crypto</span><span>/</span><span>bcrypt</span></a>"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-type">type</span> User <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  ID             <span class="token builtin">int</span>
  Username       <span class="token builtin">string</span> <span class="token string">`binding:"required,min=5,max=30"`</span>
  Password       <span class="token builtin">string</span> <span class="token string">`pg:"-" binding:"required,min=7,max=32"`</span>
  HashedPassword <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token string">`json:"-"`</span>
  Salt           <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token string">`json:"-"`</span>
  CreatedAt      time<span class="token punctuation">.</span>Time
  ModifiedAt     time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">AddUser</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  salt<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GenerateSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span>
  toHash <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span><span class="token punctuation">,</span> salt…<span class="token punctuation">)</span>
  hashedPassword<span class="token punctuation">,</span> err <span class="token operator">:=</span> bcrypt<span class="token punctuation">.</span><span class="token function">GenerateFromPassword</span><span class="token punctuation">(</span>toHash<span class="token punctuation">,</span> bcrypt<span class="token punctuation">.</span>DefaultCost<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span>

  user<span class="token punctuation">.</span>Salt <span class="token operator">=</span> salt
  user<span class="token punctuation">.</span>HashedPassword <span class="token operator">=</span> hashedPassword

  <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Returning</span><span class="token punctuation">(</span>“<span class="token operator">*</span>”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">Authenticate</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>
    “username <span class="token operator">=</span> ?”<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  salted <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>Salt…<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> bcrypt<span class="token punctuation">.</span><span class="token function">CompareHashAndPassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>HashedPassword<span class="token punctuation">,</span> salted<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> user<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">GenerateSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  salt <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>salt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> salt<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><p>再次更新一下數據庫</p><pre class=" language-go"><code class=" language-go">cd migrations<span class="token operator">/</span>
<span class="token keyword keyword-go">go</span> run <span class="token operator">*</span><span class="token punctuation">.</span><span class="token keyword keyword-go">go</span> reset
<span class="token keyword keyword-go">go</span> run <span class="token operator">*</span><span class="token punctuation">.</span><span class="token keyword keyword-go">go</span> up
</code></pre><figure class="kg-card kg-image-card"><img src="ref_files/480f6209e76647c88deed0245da19226tplv-k3u1fbpfcp-watermark" class="kg-image" alt="E2E8492B-DA4E-40B4-BBF3-98D1B0CA6C67.png" loading="lazy"></figure><p>重新在瀏覽器當中訪問頁面，並且創建帳號就看到加密後的密碼被更新到數據庫中了已經。</p><h1 id="%E5%85%AD%E3%80%81%E5%A2%9E%E5%8A%A0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%A5%E5%8F%8A%E5%A2%9E%E5%8A%A0%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC">六、增加配置文件以及增加啟動腳本</h1><p>當前我們吧服務器地址，以及端口等都硬編碼到了代碼裡，數據庫相關的選項也是如此。這不是一個優雅的解決方案，所以我們要創建一個 環境變量文件 <code>.env</code> 把相關的配置都從這個文件讀取，首先創建一個 <code>services/conf</code> 文件夾 並在裡面包含 <code>conf.go</code> 的文件</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> conf

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"log"</span>
  <span class="token string">"os"</span>
  <span class="token string">"strconv"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-const">const</span> <span class="token punctuation">(</span>
  hostKey       <span class="token operator">=</span> <span class="token string">"PHAROS_HOST"</span>
  portKey       <span class="token operator">=</span> <span class="token string">"PHAROS_PORT"</span>
  dbHostKey     <span class="token operator">=</span> <span class="token string">"PHAROS_DB_HOST"</span>
  dbPortKey     <span class="token operator">=</span> <span class="token string">"PHAROS_DB_PORT"</span>
  dbNameKey     <span class="token operator">=</span> <span class="token string">"PHAROS_DB_NAME"</span>
  dbUserKey     <span class="token operator">=</span> <span class="token string">"PHAROS_DB_USER"</span>
  dbPasswordKey <span class="token operator">=</span> <span class="token string">"PHAROS_DB_PASSWORD"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-type">type</span> Config <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  Host       <span class="token builtin">string</span>
  Port       <span class="token builtin">string</span>
  DbHost     <span class="token builtin">string</span>
  DbPort     <span class="token builtin">string</span>
  DbName     <span class="token builtin">string</span>
  DbUser     <span class="token builtin">string</span>
  DbPassword <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Config <span class="token punctuation">{</span>
  host<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>hostKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> host <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>hostKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  port<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>portKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> port <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token function">logAndPanic</span><span class="token punctuation">(</span>portKey<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  dbHost<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbHostKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbHost <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbHostKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  dbPort<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbPortKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbPort <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>dbPort<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbPortKey<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  dbName<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbNameKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbName <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbNameKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  dbUser<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbUserKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbUser <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbUserKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  dbPassword<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbPasswordKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbPassword <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbPasswordKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-return">return</span> Config<span class="token punctuation">{</span>
    Host<span class="token punctuation">:</span>       host<span class="token punctuation">,</span>
    Port<span class="token punctuation">:</span>       port<span class="token punctuation">,</span>
    DbHost<span class="token punctuation">:</span>     dbHost<span class="token punctuation">,</span>
    DbPort<span class="token punctuation">:</span>     dbPort<span class="token punctuation">,</span>
    DbName<span class="token punctuation">:</span>     dbName<span class="token punctuation">,</span>
    DbUser<span class="token punctuation">:</span>     dbUser<span class="token punctuation">,</span>
    DbPassword<span class="token punctuation">:</span> dbPassword<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">logAndPanic</span><span class="token punctuation">(</span>envVar <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>“ENV variable not set or value not valid<span class="token punctuation">:</span> “<span class="token punctuation">,</span> envVar<span class="token punctuation">)</span>
  <span class="token function">panic</span><span class="token punctuation">(</span>envVar<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>然後相應的修改一下代碼引用這些配置的邏輯。</p><p>首先修改 <code>services/database/database.go</code> 文件</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> database

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>conf”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword keyword-go">go</span><span class="token operator">-</span>pg<span class="token operator">/</span>pg<span class="token operator">/</span>v10”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">NewDBOptions</span><span class="token punctuation">(</span>cfg conf<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token operator">*</span>pg<span class="token punctuation">.</span>Options <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token operator">&amp;</span>pg<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
    Addr<span class="token punctuation">:</span>     cfg<span class="token punctuation">.</span>DbHost <span class="token operator">+</span> “<span class="token punctuation">:</span>” <span class="token operator">+</span> cfg<span class="token punctuation">.</span>DbPort<span class="token punctuation">,</span>
    Database<span class="token punctuation">:</span> cfg<span class="token punctuation">.</span>DbName<span class="token punctuation">,</span>
    User<span class="token punctuation">:</span>     cfg<span class="token punctuation">.</span>DbUser<span class="token punctuation">,</span>
    Password<span class="token punctuation">:</span> cfg<span class="token punctuation">.</span>DbPassword<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>services/server/server.go</code> 也進行相應的修改</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>conf”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>database”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>cfg conf<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">)</span>

  router <span class="token operator">:=</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Start listening and serving requests</span>
  router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>“<span class="token punctuation">:</span><span class="token number">8080</span>”<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p><code>main.go</code> 文件</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> main

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>conf”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>server”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>在 <code>migrations/main.go</code> 文件中還需要進行一項更改。 只需導入 <code>pharos/services/conf</code> 包並更改行。</p><pre class=" language-go"><code class=" language-go">store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><pre class=" language-go"><code class=" language-go">store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Enter fullscreen mode
</code></pre><p>我們現在准備讀取配置所需的 ENV 變量。 但還缺少一件事。 我們需要將這些值提供給 ENV。 為此，讓我們在名為 <code>.env</code> 的根項目目錄中創建新文件：</p><pre class=" language-go"><code class=" language-go">export PHAROS_HOST<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span>
export PHAROS_PORT<span class="token operator">=</span><span class="token number">8080</span>
export PHAROS_DB_HOST<span class="token operator">=</span>localhost
export PHAROS_DB_PORT<span class="token operator">=</span><span class="token number">5432</span>
export PHAROS_DB_NAME<span class="token operator">=</span>pharos
export PHAROS_DB_USER<span class="token operator">=</span>postgres
export PHAROS_DB_PASSWORD<span class="token operator">=</span>postgres
</code></pre><p>上下文的環境變量需要執行 <code>source .env</code> 來改變。</p><pre class=" language-bash"><code class=" language-bash">source .env
go run main.go
</code></pre><p>開發部署的Cli</p><p>現在我們有了 <code>.env</code>文件，但是每次項目開始 都要進行一次 source操作 來改變上下問的環境變臉，這樣顯得很傻，為了更優雅我們還需要創建一系列的shell 腳本，同時開發部署也需要一系列的腳本支持。我們首先在 <code>services/cli</code>創建這個目錄，然後 創建一個 <code>cli.go</code>文件。</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> cli

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “flag”
  “fmt”
  “os”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">`This program runs Pharos backend server.

Usage:

pharos [arguments]

Supported arguments:

`</span><span class="token punctuation">)</span>
  flag<span class="token punctuation">.</span><span class="token function">PrintDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  flag<span class="token punctuation">.</span>Usage <span class="token operator">=</span> usage
  env <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>“env”<span class="token punctuation">,</span> “dev”<span class="token punctuation">,</span> <span class="token string">`Sets run environment. Possible values are "dev" and "prod"`</span><span class="token punctuation">)</span>
  flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>然後修改 <code>main.go</code> 文件來加入引用</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> main

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"pharos/services/cli"</span>
  <span class="token string">"pharos/services/conf"</span>
  <span class="token string">"pharos/services/server"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cli<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>現在可以開始編寫用於部署和停止我們應用程序的 腳本了。這裡不想洗介紹 bash命令的語法，只需要理解就好 具體請參考互聯網上的一些教程和指南 我們首先創建一個文件夾 <code>scripts</code> 在跟目錄，裡面添加第一個腳本。<code>deploy.sh</code></p><pre class=" language-bash"><code class=" language-bash">#! /bin/bash

# default ENV is dev
env=dev

while test $# -gt 0; do
  case “$1” in
    -env)
      shift
      if test $# -gt 0; then
        env=$1
      fi
      # shift
      ;;
    *)
    break
    ;;
  esac
done

cd ../../pharos
source .env
go build -o pharos/pharos pharos/main.go
pharos -env $env &amp;
</code></pre><p>在上面的腳本中 我們先設置環境為 <code>env=dev</code> &nbsp;設置成為開發環境。之後我們在為這個腳本傳遞參數，如果發現 參數我們將把參數傳遞過去。設置env變量後，我們將目錄及切換到項目的根目錄，獲取 <code>env</code> 變量，然後 &nbsp;我們創建一個文件夾 <code>cmd</code> 並可以把 根目錄下的 <code>main.go</code> 文件放到此目錄下。運行 <code>go build =o cmd/pharos/pharos cmd/pharos/main.go</code> 這時候我們將創建了一個可執行文件，我們用他來啟動我們的服務。構建應用程序是，我們使用 <code>cmd/pharos/pharos -env $env &amp;</code> 啟動服務器，它將 <code>env</code> 變量的值作為-env標志傳遞給我們的服務器。</p><p>另外 我們也同時創建一個簡單的腳本 <code>stop.sh</code> 放到 <code>scripts/</code> 文件夾下面。</p><pre class=" language-bash"><code class=" language-bash">#! /bin/bash

kill $(pidof pharos)
</code></pre><p>這個腳本將找到我們 <code>pharos</code> 的進程id，並可以控制結束進程。</p><p>在使用腳本前，我們將修改一下相關的權限。</p><pre class=" language-bash"><code class=" language-bash">chmod +x deploy.sh
chmod +x stop.sh
</code></pre><p>現在我們可以控制服務的開始和結束了，<code>scripts/</code> &nbsp;下可以執行</p><pre class=" language-bash"><code class=" language-bash">./deploy.sh
./stop.sh
</code></pre><h1 id="%E4%B8%83%E3%80%81%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95">七、添加日誌記錄</h1><p>日
誌記錄也是大多數 Web 應用程序中非常重要的部分，因為我們通常想知道傳入了哪些請求，更重要的是，是否有任何意外錯誤。 
因此，正如您可能已經猜到的那樣，本節將介紹日誌記錄，我將向您展示如何設置日誌記錄，以及如何在開發和生產環境中分離日誌記錄。 
現在我們將使用上一節中添加的 -env 標志。</p><p>對於日誌記錄，我們將使用<a href="https://github.com/rs/zerolog">zerolog</a>模塊，您可以通過運行 &nbsp;<code>go get <a class="vglnk" href="http://github.com/rs/zerolog/log" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>rs</span><span>/</span><span>zerolog</span><span>/</span><span>log</span></a></code> 來獲取該模塊。</p><p>現在我們再創建另一個目錄 <code>services/logging</code> 並在其中創建一個 <code>logging.go</code> 文件。</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> logging

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"fmt"</span>
  <span class="token string">"io"</span>
  <span class="token string">"io/ioutil"</span>
  <span class="token string">"os"</span>
  <span class="token string">"path/filepath"</span>
  <span class="token string">"strings"</span>
  <span class="token string">"time"</span>

  <span class="token string">"<a class="vglnk" href="http://github.com/gin-gonic/gin" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>gin</span><span>-</span><span>gonic</span><span>/</span><span>gin</span></a>"</span>
  <span class="token string">"<a class="vglnk" href="http://github.com/rs/zerolog" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>rs</span><span>/</span><span>zerolog</span></a>"</span>
  <span class="token string">"<a class="vglnk" href="http://github.com/rs/zerolog/log" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>rs</span><span>/</span><span>zerolog</span><span>/</span><span>log</span></a>"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-const">const</span> <span class="token punctuation">(</span>
  logsDir <span class="token operator">=</span> <span class="token string">"logs"</span>
  logName <span class="token operator">=</span> <span class="token string">"gin_production.log"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-var">var</span> logFilePath <span class="token operator">=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>logsDir<span class="token punctuation">,</span> logName<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">SetGinLogToFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gin<span class="token punctuation">.</span><span class="token function">SetMode</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>ReleaseMode<span class="token punctuation">)</span>
  logFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>logFilePath<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span><span class="token string">"Error opening Gin log file"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  gin<span class="token punctuation">.</span>DefaultWriter <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">MultiWriter</span><span class="token punctuation">(</span>logFile<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">ConfigureLogger</span><span class="token punctuation">(</span>env <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  zerolog<span class="token punctuation">.</span><span class="token function">SetGlobalLevel</span><span class="token punctuation">(</span>zerolog<span class="token punctuation">.</span>DebugLevel<span class="token punctuation">)</span>
  <span class="token keyword keyword-switch">switch</span> env <span class="token punctuation">{</span>
  <span class="token keyword keyword-case">case</span> <span class="token string">"dev"</span><span class="token punctuation">:</span>
    stdOutWriter <span class="token operator">:=</span> zerolog<span class="token punctuation">.</span>ConsoleWriter<span class="token punctuation">{</span>Out<span class="token punctuation">:</span> os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> TimeFormat<span class="token punctuation">:</span> <span class="token string">"15:04:05.000"</span><span class="token punctuation">}</span>
    logger <span class="token operator">:=</span> zerolog<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>stdOutWriter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> logger
  <span class="token keyword keyword-case">case</span> <span class="token string">"prod"</span><span class="token punctuation">:</span>
    <span class="token function">createLogDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">backupLastLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    logFile <span class="token operator">:=</span> <span class="token function">openLogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    logFileWriter <span class="token operator">:=</span> zerolog<span class="token punctuation">.</span>ConsoleWriter<span class="token punctuation">{</span>Out<span class="token punctuation">:</span> logFile<span class="token punctuation">,</span> NoColor<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> TimeFormat<span class="token punctuation">:</span> <span class="token string">"15:04:05.000"</span><span class="token punctuation">}</span>
    logger <span class="token operator">:=</span> zerolog<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>logFileWriter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> logger
  <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Env not valid: %s\n"</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">createLogDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>logsDir<span class="token punctuation">,</span> <span class="token number">0744</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span><span class="token string">"Unable to create logs directory."</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">backupLastLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  timeStamp <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"20060201_15_04_05"</span><span class="token punctuation">)</span>
  base <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSuffix</span><span class="token punctuation">(</span>logName<span class="token punctuation">,</span> filepath<span class="token punctuation">.</span><span class="token function">Ext</span><span class="token punctuation">(</span>logName<span class="token punctuation">)</span><span class="token punctuation">)</span>
  bkpLogName <span class="token operator">:=</span> base <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> timeStamp <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> filepath<span class="token punctuation">.</span><span class="token function">Ext</span><span class="token punctuation">(</span>logName<span class="token punctuation">)</span>
  bkpLogPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>logsDir<span class="token punctuation">,</span> bkpLogName<span class="token punctuation">)</span>

  logFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>logFilePath<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-return">return</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error reading log file <span class="token keyword keyword-for">for</span> backup”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-if">if</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>bkpLogPath<span class="token punctuation">,</span> logFile<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error writing backup log file”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">openLogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>os<span class="token punctuation">.</span>File <span class="token punctuation">{</span>
  logFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>logFilePath<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error while opening log file”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> logFile
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">curentDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Executable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Can’t get current directory<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> filepath<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>然後我們可以更新 <code>services/cli/cli.go</code> 以根據環境配置日誌記錄，而不是僅僅打印它</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> cli

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"flag"</span>
  <span class="token string">"fmt"</span>
  “os”

  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>logging”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">`This program runs PHAROS backend server.

Usage:

pharos [arguments]

Supported arguments:

`</span><span class="token punctuation">)</span>
  flag<span class="token punctuation">.</span><span class="token function">PrintDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  flag<span class="token punctuation">.</span>Usage <span class="token operator">=</span> usage
  env <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>“env”<span class="token punctuation">,</span> “dev”<span class="token punctuation">,</span> <span class="token string">`Sets run environment. Possible values are "dev" and "prod"`</span><span class="token punctuation">)</span>
  flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  logging<span class="token punctuation">.</span><span class="token function">ConfigureLogger</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">*</span>env <span class="token operator">==</span> “prod” <span class="token punctuation">{</span>
    logging<span class="token punctuation">.</span><span class="token function">SetGinLogToFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>這看起來像很多代碼，但它非常簡單。 首先我們根據環境配置我們的日誌。 如果 env 是 
dev，我們會將所有內容都記錄到 stdout，而對於 prod 環境，我們將登錄到文件中。 
登錄文件時，我們將首先根據需要創建日誌目錄並備份以前的日誌，因此每次服務器啟動時我們都有新的日誌。 
當然，您可以為日誌輪換創建不同的邏輯，以更好地滿足您的需求。 在這種情況下我們需要做的另一件事是告訴 Gin 
以發布模式運行，這將減少不必要和干擾的輸出，然後還設置默認 Gin writer 寫入日誌文件。 您也可以在 <code>prod case</code> 塊中執行此操作，但由於我們實際上有兩個不同的記錄器（Gin 的附加記錄器和我們的 zerolog 記錄器），我更傾向於將這兩部分代碼分開。 這只是個人喜好，您可以按照自己的方式進行。 有了這個集合，我們現在可以開始記錄一些錯誤。 例如，讓我們更新 <code>services/conf/conf.go</code> 中的 <code> logAndPanic()</code>函數：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">logAndPanic</span><span class="token punctuation">(</span>envVar <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Str</span><span class="token punctuation">(</span>“envVar”<span class="token punctuation">,</span> envVar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“ENV variable not set or value not valid”<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>我們可以記錄在 <code>services/store/users.go</code> 中生成密鑰的時候是否發生錯誤。</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">GenerateSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  salt <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>salt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Unable to create salt”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> salt<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><h1 id="%E5%85%AB%E3%80%81jwt-authentication">八、JWT authentication</h1><p>身
份驗證是幾乎每個 Web 應用程序中最重要的部分之一。 我們必須確保每個用戶只能創建、讀取、更新和刪除其授權的數據。 為此，我們將使用 
JWT（JSON Web 密鑰）。 幸運的是，有各種專門用於此的 Golang 模塊。 本指南中將使用的一個可以在此 GitHub 
存儲庫中找到。 當前最新版本是 v3，可以通過運行 <code>go get <a class="vglnk" href="http://github.com/cristalhq/jwt/v3" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>cristalhq</span><span>/</span><span>jwt</span><span>/</span><span>v3</span></a></code> 來安裝。</p><p>由於我們將需要用於生成和驗證令牌的密鑰，讓我們將 <code>export PHAROS_JWT_SECRET=jwtSecret123</code> 添加到我們的 <code>.env </code>文件中。 當然，在生產中你會想要使用一些隨機生成的長字符串。<br>接下來我們應該做的是在 <code>services/conf/conf.go</code> 中添加新變量。 我們將添加常量 <code>jwtSecretKey = "PHAROS_JWT_SECRET"</code> 與我們的其餘常量，然後將字符串類型的新字段 <code>JwtSecret </code>添加到配置結構。 現在我們可以讀取新的 env 變量並將其添加到 <code>NewConfig()</code>函數中：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-const">const</span> <span class="token punctuation">(</span>
  hostKey       <span class="token operator">=</span> <span class="token string">"PHAROS_HOST"</span>
  portKey       <span class="token operator">=</span> <span class="token string">"PHAROS_PORT"</span>
  dbHostKey     <span class="token operator">=</span> <span class="token string">"PHAROS_DB_HOST"</span>
  dbPortKey     <span class="token operator">=</span> <span class="token string">"PHAROS_DB_PORT"</span>
  dbNameKey     <span class="token operator">=</span> <span class="token string">"PHAROS_DB_NAME"</span>
  dbUserKey     <span class="token operator">=</span> <span class="token string">"PHAROS_DB_USER"</span>
  dbPasswordKey <span class="token operator">=</span> <span class="token string">"PHAROS_DB_PASSWORD"</span>
  jwtSecretKey  <span class="token operator">=</span> <span class="token string">"PHAROS_JWT_SECRET"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-type">type</span> Config <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  Host       <span class="token builtin">string</span>
  Port       <span class="token builtin">string</span>
  DbHost     <span class="token builtin">string</span>
  DbPort     <span class="token builtin">string</span>
  DbName     <span class="token builtin">string</span>
  DbUser     <span class="token builtin">string</span>
  DbPassword <span class="token builtin">string</span>
  JwtSecret  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Config <span class="token punctuation">{</span>
  host<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>hostKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> host <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>hostKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  port<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>portKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> port <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token function">logAndPanic</span><span class="token punctuation">(</span>portKey<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  dbHost<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbHostKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbHost <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbHostKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  dbPort<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbPortKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbPort <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>dbPort<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbPortKey<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  dbName<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbNameKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbNameKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  dbUser<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbUserKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbUser <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbUserKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  dbPassword<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>dbPasswordKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> dbPassword <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>dbPasswordKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  jwtSecret<span class="token punctuation">,</span> ok <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span>jwtSecretKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> jwtSecret <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    <span class="token function">logAndPanic</span><span class="token punctuation">(</span>jwtSecretKey<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-return">return</span> Config<span class="token punctuation">{</span>
    Host<span class="token punctuation">:</span>       host<span class="token punctuation">,</span>
    Port<span class="token punctuation">:</span>       port<span class="token punctuation">,</span>
    DbHost<span class="token punctuation">:</span>     dbHost<span class="token punctuation">,</span>
    DbPort<span class="token punctuation">:</span>     dbPort<span class="token punctuation">,</span>
    DbName<span class="token punctuation">:</span>     dbName<span class="token punctuation">,</span>
    DbUser<span class="token punctuation">:</span>     dbUser<span class="token punctuation">,</span>
    DbPassword<span class="token punctuation">:</span> dbPassword<span class="token punctuation">,</span>
    JwtSecret<span class="token punctuation">:</span>  jwtSecret<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>我們可以創建一個新的文件 <code>services/server/jwt.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>conf”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>cristalhq<span class="token operator">/</span>jwt<span class="token operator">/</span>v3”
  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>rs<span class="token operator">/</span>zerolog<span class="token operator">/</span>log”
<span class="token punctuation">)</span>

<span class="token keyword keyword-var">var</span> <span class="token punctuation">(</span>
  jwtSigner   jwt<span class="token punctuation">.</span>Signer
  jwtVerifier jwt<span class="token punctuation">.</span>Verifier
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">jwtSetup</span><span class="token punctuation">(</span>conf conf<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-var">var</span> err <span class="token builtin">error</span>
  key <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>JwtSecret<span class="token punctuation">)</span>

  jwtSigner<span class="token punctuation">,</span> err <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">NewSignerHS</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>HS256<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error creating JWT signer”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  jwtVerifier<span class="token punctuation">,</span> err <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">NewVerifierHS</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>HS256<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error creating JWT verifier”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>函數 <code>jwtSetup()</code>將只創建稍後將用於身份驗證的簽名者和驗證者。 現在我們可以在啟動服務器時從 <code>services/server/server/go</code> 調用這個函數：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>conf”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>database”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>cfg conf<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">jwtSetup</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>

  store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">)</span>

  router <span class="token operator">:=</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Start listening and serving requests</span>
  router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>“<span class="token punctuation">:</span><span class="token number">8080</span>”<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>為了生成密鑰，我們將在 <code>services/server/jwt.go</code> 中創建函數：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">generateJWT</span><span class="token punctuation">(</span>user <span class="token operator">*</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  claims <span class="token operator">:=</span> <span class="token operator">&amp;</span>jwt<span class="token punctuation">.</span>RegisteredClaims<span class="token punctuation">{</span>
    ID<span class="token punctuation">:</span>        fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ExpiresAt<span class="token punctuation">:</span> jwt<span class="token punctuation">.</span><span class="token function">NewNumericDate</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  builder <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span>jwtSigner<span class="token punctuation">)</span>
  token<span class="token punctuation">,</span> err <span class="token operator">:=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error building JWT”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> token<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>然後我們將從 <code>services/server/user.go</code> 調用它，而不是我們迄今為止用於測試目的的硬編碼字符串：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “net<span class="token operator">/</span>http”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">signUp</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">AddUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span> “Signed up successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “jwt”<span class="token punctuation">:</span> <span class="token function">generateJWT</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">signIn</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">Authenticate</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Sign in failed<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>

  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span> “Signed in successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “jwt”<span class="token punctuation">:</span> <span class="token function">generateJWT</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>讓我們通過注冊或通過我們的前端登錄來測試這一點。 打開瀏覽器開發工具並檢查登錄或注冊響應。 您可以看到我們的後端現在生成了隨機 JWT：</p><figure class="kg-card kg-image-card"><img src="ref_files/e0289c2985104e979168626a40569d8btplv-k3u1fbpfcp-watermark" class="kg-image" alt="BF9C0E23-0297-4038-99CC-8F90DDB6EF8F.png" loading="lazy"></figure><p>令牌現在在 signIn 和 signUp 處理程序中創建，這意味著我們可以為所有安全路由驗證它。 為此，我們將首先在 <code>services/server/jwt.go</code> 中實現 <code>verifyJWT()</code>函數。 此函數將接收字符串形式的令牌，驗證其簽名，從聲明中提取 ID，如果一切正常，用戶 ID 將作為 int 返回：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">verifyJWT</span><span class="token punctuation">(</span>tokenStr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  token<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>tokenStr<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Str</span><span class="token punctuation">(</span>“tokenStr”<span class="token punctuation">,</span> tokenStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error parsing JWT”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> jwtVerifier<span class="token punctuation">.</span><span class="token function">Verify</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">Payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">Signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error verifying token”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-var">var</span> claims jwt<span class="token punctuation">.</span>StandardClaims
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">RawClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error unmarshalling JWT claims”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-if">if</span> notExpired <span class="token operator">:=</span> claims<span class="token punctuation">.</span><span class="token function">IsValidAt</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>notExpired <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>“Token expired<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  id<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Str</span><span class="token punctuation">(</span>“claims<span class="token punctuation">.</span>ID”<span class="token punctuation">,</span> claims<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error converting claims ID to number”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>“ID in token is not valid”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> id<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><p>生成和驗證的功能都完成了，到此我們幾乎可以編寫用於授權的 Gin 中間件了。 在此之前，我們將添加根據用戶 ID 從數據庫中獲取用戶的函數。 在 <code>services/store/users.go</code> 中，添加函數：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">FetchUser</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  user<span class="token punctuation">.</span>ID <span class="token operator">=</span> id
  err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Returning</span><span class="token punctuation">(</span>“<span class="token operator">*</span>”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WherePK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error fetching user”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> user<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><p>現在可以創建一個新文件 <code>services/server/middleware.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “net<span class="token operator">/</span>http”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”
  “strings”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">authorization</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  authHeader <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span>“Authorization”<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> authHeader <span class="token operator">==</span> “” <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Authorization header missing<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  headerParts <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">,</span> “ “<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headerParts<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Authorization header format is not valid<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> headerParts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> “Bearer” <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Authorization header is missing bearer part<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  userID<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">verifyJWT</span><span class="token punctuation">(</span>headerParts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">FetchUser</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>“user”<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>授權中間件從授權頭中提取令牌。 它首先檢查標頭是否存在，是否為有效格式，然後調用 <code>verifyJWT()</code>函數。 如果 JWT 驗證通過，則返回用戶 ID。 從數據庫中獲取具有該 ID 的用戶並將其設置為此上下文的當前用戶。</p><p>從上下文中獲取當前用戶是我們經常需要的東西，所以讓我們將其提取到輔助函數中：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">currentUser</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>store<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-var">var</span> err <span class="token builtin">error</span>
  _user<span class="token punctuation">,</span> exists <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>“user”<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span>
    err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>“Current context user not set”<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  user<span class="token punctuation">,</span> ok <span class="token operator">:=</span> _user<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
    err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>“Context user is not valid <span class="token keyword keyword-type">type</span>”<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> user<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><p>首先，我們檢查是否為此上下文設置了用戶。 如果不是，則返回錯誤。 由於 <code>ctx.Get()</code>返回接口，我們必須檢查 value 是否為 <code>*store.User</code> 類型。 如果不是，則返回錯誤。 當兩個檢查都通過時，當前用戶從上下文返回。</p><h1 id="%E4%B9%9D%E3%80%81%E5%A2%9E%E5%8A%A0%E5%8F%91%E5%B8%96%E5%8A%9F%E8%83%BD">九、增加發帖功能</h1><p>身份驗證到位後，是時候開始使用它了。 我們需要身份驗證才能創建、閱讀、更新和刪除用戶的博客文章。 讓我們從添加新的數據庫遷移開始，這將創建包含列的所需數據表。 創建新的遷移文件 <code>migrations/2_addPostsTable.go</code>：·</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> main

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “fmt”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword keyword-go">go</span><span class="token operator">-</span>pg<span class="token operator">/</span>migrations<span class="token operator">/</span>v8”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  migrations<span class="token punctuation">.</span><span class="token function">MustRegisterTx</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>db migrations<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>“creating table posts…”<span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">`CREATE TABLE posts(
      id SERIAL PRIMARY KEY,
      title TEXT NOT NULL,
      content TEXT NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      modified_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      user_id INT REFERENCES users ON DELETE CASCADE
    )`</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>db migrations<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>“dropping table posts…”<span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">`DROP TABLE posts`</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>然後運行 migrations</p><pre class=" language-bash"><code class=" language-bash">cd migrations/
go run *.go up
</code></pre><p>現在我們創建結構來保存帖子數據。 我們還將為標題和內容添加字段約束。 添加新文件 <code>services/store/posts.go</code>：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> store

<span class="token keyword keyword-import">import</span> “time”

<span class="token keyword keyword-type">type</span> Post <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  ID         <span class="token builtin">int</span>
  Title      <span class="token builtin">string</span>    <span class="token string">`binding:"required,min=3,max=50"`</span>
  Content    <span class="token builtin">string</span>    <span class="token string">`binding:"required,min=5,max=5000"`</span>
  CreatedAt  time<span class="token punctuation">.</span>Time
  ModifiedAt time<span class="token punctuation">.</span>Time
  UserID     <span class="token builtin">int</span> <span class="token string">`json:"-"`</span>
<span class="token punctuation">}</span>
</code></pre><p>用戶可以有多個博客文章，因此我們必須添加與用戶結構的多關系。 在 <code>services/store/users.go</code> 中，編輯 User 結構：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-type">type</span> User <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  ID             <span class="token builtin">int</span>
  Username       <span class="token builtin">string</span> <span class="token string">`binding:"required,min=5,max=30"`</span>
  Password       <span class="token builtin">string</span> <span class="token string">`pg:"-" binding:"required,min=7,max=32"`</span>
  HashedPassword <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token string">`json:"-"`</span>
  Salt           <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token string">`json:"-"`</span>
  CreatedAt      time<span class="token punctuation">.</span>Time
  ModifiedAt     time<span class="token punctuation">.</span>Time
  Posts          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Post <span class="token string">`json:"-" pg:"fk:user_id,rel:has-many,on_delete:CASCADE"`</span>
<span class="token punctuation">}</span>
</code></pre><p>可以在數據庫中插入新帖子條目的功能將在 <code>services/store/posts.go </code>中實現：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">AddPost</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">,</span> post <span class="token operator">*</span>Post<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  post<span class="token punctuation">.</span>UserID <span class="token operator">=</span> user<span class="token punctuation">.</span>ID
  <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Returning</span><span class="token punctuation">(</span>“<span class="token operator">*</span>”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error inserting <span class="token builtin">new</span> post”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> err
<span class="token punctuation">}</span>
</code></pre><p>要創建帖子，我們將添加新的處理程序，它將調用上面的函數。 創建新文件 <code>services/server/post.go</code>：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “net<span class="token operator">/</span>http”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">createPost</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  post <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>Post<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">currentUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">AddPost</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span>  “Post created successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “data”<span class="token punctuation">:</span> post<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>帖子創建處理程序已准備就緒，讓我們為創建帖子添加新的受保護路由。 在 <code>services/server/router.go</code> 中，我們將創建新組，該組將使用我們在前一章中實現的授權中間件。 我們將使用 HTTP 方法 POST 添加路由 <code>/posts</code> 到該受保護組：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Creates default gin router with Logger and Recovery middleware already attached</span>
  router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Enables automatic redirection if the current route can’t be matched but a</span>
  <span class="token comment" spellcheck="true">// handler for the path with (without) the trailing slash exists.</span>
  router<span class="token punctuation">.</span>RedirectTrailingSlash <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment" spellcheck="true">// Create API route group</span>
  api <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>api”<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signup”<span class="token punctuation">,</span> signUp<span class="token punctuation">)</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signin”<span class="token punctuation">,</span> signIn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  authorized <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>“<span class="token punctuation">)</span>
  authorized<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    authorized<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> createPost<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  router<span class="token punctuation">.</span><span class="token function">NoRoute</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> router
<span class="token punctuation">}</span>
</code></pre><p>所有其他 CRUD（創建、讀取、更新、刪除）方法的配方都是相同的：</p><ol><li>實現與數據庫通信以執行所需操作的功能</li><li>實現 Gin 處理程序，它將使用步驟 1 中的函數</li><li>將帶有處理程序的路由添加到路由器</li></ol><p>我們已經涵蓋了創建部分，所以讓我們繼續下一個方法，閱讀。 我們將實現從 <code>services/store/posts.go</code> 數據庫中獲取所有用戶帖子的函數：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">FetchUserPosts</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token function">Relation</span><span class="token punctuation">(</span>“Posts”<span class="token punctuation">,</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>q <span class="token operator">*</span>orm<span class="token punctuation">.</span>Query<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>orm<span class="token punctuation">.</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-return">return</span> q<span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span>“id ASC”<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error fetching user’s posts”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> err
<span class="token punctuation">}</span>
</code></pre><p>添加一個文件 <code>services/server/post.go</code> :</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">indexPosts</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">currentUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">FetchUserPosts</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span>  “Posts fetched successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “data”<span class="token punctuation">:</span> user<span class="token punctuation">.</span>Posts<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>要更新帖子，請將這兩個函數添加到 <code>services/store/posts.go</code>：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">FetchPost</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Post<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  post <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Post<span class="token punctuation">)</span>
  post<span class="token punctuation">.</span>ID <span class="token operator">=</span> id
  err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WherePK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error fetching post”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> post<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">UpdatePost</span><span class="token punctuation">(</span>post <span class="token operator">*</span>Post<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WherePK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UpdateNotZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error updating post”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> err
<span class="token punctuation">}</span>
</code></pre><p>修改 <code>services/server/post.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">updatePost</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  jsonPost <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>Post<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>jsonPost<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">currentUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  dbPost<span class="token punctuation">,</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">FetchPost</span><span class="token punctuation">(</span>jsonPost<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> user<span class="token punctuation">.</span>ID <span class="token operator">!=</span> dbPost<span class="token punctuation">.</span>UserID <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Not authorized<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  jsonPost<span class="token punctuation">.</span>ModifiedAt <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">UpdatePost</span><span class="token punctuation">(</span>jsonPost<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span>  “Post updated successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “data”<span class="token punctuation">:</span> jsonPost<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>還有一個刪除相關 <code>services/store/posts.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">DeletePost</span><span class="token punctuation">(</span>post <span class="token operator">*</span>Post<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WherePK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error deleting post”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> err
<span class="token punctuation">}</span>
</code></pre><p>在 <code>services/server/post.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">deletePost</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  paramID <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span>“id”<span class="token punctuation">)</span>
  id<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>paramID<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Not valid ID<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">currentUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  post<span class="token punctuation">,</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">FetchPost</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> user<span class="token punctuation">.</span>ID <span class="token operator">!=</span> post<span class="token punctuation">.</span>UserID <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Not authorized<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">DeletePost</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“msg”<span class="token punctuation">:</span> “Post deleted successfully<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>您可以在這裡注意到的一項新事物是 <code>paramID := ctx.Param("id")</code>。 我們正在使用它從 URL 路徑中提取 ID 參數。</p><p>讓我們將所有這些處理程序添加到路由器：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Creates default gin router with Logger and Recovery middleware already attached</span>
  router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Enables automatic redirection if the current route can’t be matched but a</span>
  <span class="token comment" spellcheck="true">// handler for the path with (without) the trailing slash exists.</span>
  router<span class="token punctuation">.</span>RedirectTrailingSlash <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment" spellcheck="true">// Create API route group</span>
  api <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>api”<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signup”<span class="token punctuation">,</span> signUp<span class="token punctuation">)</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signin”<span class="token punctuation">,</span> signIn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  authorized <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>“<span class="token punctuation">)</span>
  authorized<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    authorized<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> indexPosts<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> createPost<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> updatePost<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts<span class="token operator">/</span><span class="token punctuation">:</span>id”<span class="token punctuation">,</span> deletePost<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  router<span class="token punctuation">.</span><span class="token function">NoRoute</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> router
<span class="token punctuation">}</span>
</code></pre><p>如果用戶還沒有帖子，<code>User.Posts</code> 字段默認為 nil。 這使前端的事情變得復雜，因為它必須檢查 nil 值，所以最好使用空切片。 為此，我們將使用 <code>AfterSelectHook</code>，它會在每次為 User 執行 <code>Select()</code> 後執行。 該鉤子將被添加到 <code>services/store/users.go</code>：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-var">var</span> <span class="token boolean">_</span> pg<span class="token punctuation">.</span>AfterSelectHook <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterSelect</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-if">if</span> user<span class="token punctuation">.</span>Posts <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    user<span class="token punctuation">.</span>Posts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Post<span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><h1 id="%E5%8D%81%E3%80%81%E9%94%99%E8%AF%AF%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">十、錯誤異常處理</h1><p>如果您嘗試使用太短的密碼創建新帳戶，您將收到錯誤 <code>Key: 'User.Password' Error:Field validation for 'Password' failed on the 'min'</code> 標簽。 這不是真正好的用戶體驗，因此應該對其進行更改以獲得更好的用戶體驗。 讓我們看看如何將其轉換為我們自己的自定義錯誤消息。 為此，我們將在 <code>services/server/middleware.go</code> 文件中創建新的 Gin 處理程序函數：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">customErrors</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token function">len</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Errors<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> ctx<span class="token punctuation">.</span>Errors <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Check error type</span>
      <span class="token keyword keyword-switch">switch</span> err<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
      <span class="token keyword keyword-case">case</span> gin<span class="token punctuation">.</span>ErrorTypePublic<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// Show public errors only if nothing has been written yet</span>
        <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Written</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token keyword keyword-case">case</span> gin<span class="token punctuation">.</span>ErrorTypeBind<span class="token punctuation">:</span>
        errMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> errs<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span>Err<span class="token punctuation">.</span><span class="token punctuation">(</span>validator<span class="token punctuation">.</span>ValidationErrors<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
          <span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fieldErr <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>validator<span class="token punctuation">.</span><span class="token function">FieldError</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errMap<span class="token punctuation">[</span>fieldErr<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">customValidationError</span><span class="token punctuation">(</span>fieldErr<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        status <span class="token operator">:=</span> http<span class="token punctuation">.</span>StatusBadRequest
        <span class="token comment" spellcheck="true">// Preserve current status</span>
        <span class="token keyword keyword-if">if</span> ctx<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">{</span>
          status <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> errMap<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// Log other errors</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>Err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Other <span class="token builtin">error</span>”<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// If there was no public or bind error, display default 500 message</span>
    <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Written</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> InternalServerError<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">customValidationError</span><span class="token punctuation">(</span>err validator<span class="token punctuation">.</span>FieldError<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-switch">switch</span> err<span class="token punctuation">.</span><span class="token function">Tag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-case">case</span> “required”<span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>“<span class="token operator">%</span>s is required<span class="token punctuation">.</span>”<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-case">case</span> “min”<span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>“<span class="token operator">%</span>s must be longer than or equal <span class="token operator">%</span>s characters<span class="token punctuation">.</span>”<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-case">case</span> “max”<span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>“<span class="token operator">%</span>s cannot be longer than <span class="token operator">%</span>s characters<span class="token punctuation">.</span>”<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>在 <code>internal/server/server.go</code> 中定義常量 <code>InternalServerError</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-const">const</span> InternalServerError <span class="token operator">=</span> “Something went wrong<span class="token operator">!</span>”
</code></pre><p>讓我們在 <code>services/server/router.go</code> 中使用新的 Gin 中間件：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Creates default gin router with Logger and Recovery middleware already attached</span>
  router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Enables automatic redirection if the current route can’t be matched but a</span>
  <span class="token comment" spellcheck="true">// handler for the path with (without) the trailing slash exists.</span>
  router<span class="token punctuation">.</span>RedirectTrailingSlash <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment" spellcheck="true">// Create API route group</span>
  api <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>api”<span class="token punctuation">)</span>
  api<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>customErrors<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signup”<span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signUp<span class="token punctuation">)</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signin”<span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signIn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  authorized <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>“<span class="token punctuation">)</span>
  authorized<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    authorized<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> indexPosts<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> createPost<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> updatePost<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts<span class="token operator">/</span><span class="token punctuation">:</span>id”<span class="token punctuation">,</span> deletePost<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  router<span class="token punctuation">.</span><span class="token function">NoRoute</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> router
<span class="token punctuation">}</span>
</code></pre><p>我們現在在 api 組中使用 <code>customErrors</code> 中間件。 但這並不是唯一的變化。 注意登錄和注冊的更新路由：</p><pre class=" language-go"><code class=" language-go">api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signup”<span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signUp<span class="token punctuation">)</span>
api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signin”<span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signIn<span class="token punctuation">)</span>
</code></pre><p>通過這些更改，我們甚至會在點擊 signUp 和 signIn 
處理程序之前嘗試綁定請求數據，這意味著只有在表單驗證通過時才會到達處理程序。 
通過這樣的設置，處理程序不需要考慮綁定錯誤，因為如果到達處理程序就沒有綁定錯誤。 考慮到這一點，讓我們更新這兩個處理程序：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">signUp</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">MustGet</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>BindKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">AddUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span> “Signed up successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “jwt”<span class="token punctuation">:</span> <span class="token function">generateJWT</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">signIn</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">MustGet</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>BindKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>store<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">Authenticate</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>“<span class="token builtin">error</span>”<span class="token punctuation">:</span> “Sign in failed<span class="token punctuation">.</span>”<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
  <span class="token punctuation">}</span>

  ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    “msg”<span class="token punctuation">:</span> “Signed in successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span>
    “jwt”<span class="token punctuation">:</span> <span class="token function">generateJWT</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>我們的處理程序現在簡單得多，它們只處理數據庫錯誤。 如果您再次嘗試使用太短的用戶名和密碼創建帳戶，您將看到更具可讀性和描述性的錯誤：</p><p>上面提到了頁面登陸相關的錯誤，如果數據庫發生錯誤我們也呀優雅的處理，您嘗試使用現有用戶名創建帳戶，<code>ERROR #23505 duplicate key value violates unique constraint “users_username_key”</code>。 不幸的是，這裡沒有涉及驗證器，<code>pg</code> 模塊將大部分錯誤返回為 <code>map[byte]string</code>，因此這可能有點棘手。</p><p>一種方法是通過執行數據庫查詢手動檢查每個錯誤情況。 例如，要檢查具有給定用戶名的用戶是否已存在於數據庫中，我們可以在嘗試創建新用戶之前執行此操作：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">AddUser</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>“username <span class="token operator">=</span> ?”<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>“Username already exists<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  …
<span class="token punctuation">}</span>
</code></pre><p>問題是這會變得非常乏味。 需要針對與數據庫通信的每個函數中的每個錯誤情況執行此操作。 
最重要的是，我們不必要地增加了數據庫查詢。 在這個簡單的例子中，對於每個成功的用戶創建，現在將有 2 個數據庫查詢，而不是 1 個。 
還有一種方法，那就是嘗試做一次查詢，如果發生錯誤再解析。 
這是棘手的部分，因為我們需要使用正則表達式處理每種錯誤類型，以提取創建更用戶友好的自定義錯誤消息所需的相關數據。 那麼讓我們開始吧。 
如前所述，pg 錯誤主要是 map[byte]string 
類型，因此當您嘗試使用現有用戶名創建用戶帳戶時，對於此特定錯誤，您將在下圖中獲得Map對象：</p><figure class="kg-card kg-image-card"><img src="ref_files/f964734fb5514a57b24143b7781c2372tplv-k3u1fbpfcp-watermark.png" class="kg-image" alt="B5566213-AA61-4F8F-8116-C7CC3210C971.png" loading="lazy"></figure><p>為了提取相關數據，我們將使用字段 82 和 110。錯誤類型將從字段 82 中讀取，我們將從字段 110 中提取列名。讓我們將這些函數添加到 <code>services/store/store.go</code>：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">dbError</span><span class="token punctuation">(</span>_err <span class="token keyword keyword-interface">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-if">if</span> _err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-switch">switch</span> _err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword keyword-type">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-case">case</span> pg<span class="token punctuation">.</span>Error<span class="token punctuation">:</span>
    err <span class="token operator">:=</span> _err<span class="token punctuation">.</span><span class="token punctuation">(</span>pg<span class="token punctuation">.</span>Error<span class="token punctuation">)</span>
    <span class="token keyword keyword-switch">switch</span> err<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">82</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-case">case</span> “_bt_check_unique”<span class="token punctuation">:</span>
      <span class="token keyword keyword-return">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token function">extractColumnName</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> “ already exists<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token keyword keyword-case">case</span> <span class="token builtin">error</span><span class="token punctuation">:</span>
    err <span class="token operator">:=</span> _err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-switch">switch</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-case">case</span> “pg<span class="token punctuation">:</span> no rows in result set”<span class="token punctuation">:</span>
      <span class="token keyword keyword-return">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>“Not found<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span>_err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">extractColumnName</span><span class="token punctuation">(</span>text <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  reg <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`.+_(.+)_.+`</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> reg<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">FindStringSubmatch</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> “Unknown”
<span class="token punctuation">}</span>
</code></pre><p>有了這個，我們可以從 <code>services/store/users.go</code> 調用這個 <code>dbError()</code>函數：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">AddUser</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  …

  <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Returning</span><span class="token punctuation">(</span>“<span class="token operator">*</span>”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error inserting <span class="token builtin">new</span> user”<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">dbError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><p>如果我們使用已有的用戶名，就可以提示一個更優雅的提示了。</p><p>另外還需要優雅的是關閉服務。 我們要修改一下 <code>services/server/server.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “context”
  “errors”
  “net<span class="token operator">/</span>http”
  “os”
  “os<span class="token operator">/</span>signal”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>conf”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>database”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”
  “syscall”
  “time”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>rs<span class="token operator">/</span>zerolog<span class="token operator">/</span>log”
<span class="token punctuation">)</span>

<span class="token keyword keyword-const">const</span> InternalServerError <span class="token operator">=</span> “Something went wrong<span class="token operator">!</span>”

<span class="token keyword keyword-func">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>cfg conf<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">jwtSetup</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>

  store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">)</span>

  router <span class="token operator">:=</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
    Addr<span class="token punctuation">:</span>    cfg<span class="token punctuation">.</span>Host <span class="token operator">+</span> “<span class="token punctuation">:</span>” <span class="token operator">+</span> cfg<span class="token punctuation">.</span>Port<span class="token punctuation">,</span>
    Handler<span class="token punctuation">:</span> router<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// Initializing the server in a goroutine so that</span>
  <span class="token comment" spellcheck="true">// it won’t block the graceful shutdown handling below</span>
  <span class="token keyword keyword-go">go</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> http<span class="token punctuation">.</span>ErrServerClosed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Server ListenAndServe <span class="token builtin">error</span>”<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Wait for interrupt signal to gracefully shutdown the server with</span>
  <span class="token comment" spellcheck="true">// a timeout of 5 seconds.</span>
  quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword keyword-chan">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
  <span class="token comment" spellcheck="true">// kill (no param) default send syscall.SIGTERM</span>
  <span class="token comment" spellcheck="true">// kill -2 is syscall.SIGINT</span>
  <span class="token comment" spellcheck="true">// kill -9 is syscall.SIGKILL but can’t be catch, so don’t need add it</span>
  signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
  <span class="token operator">&lt;-</span>quit
  log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Shutting down server…”<span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// The context is used to inform the server it has 5 seconds to finish</span>
  <span class="token comment" spellcheck="true">// the request it is currently handling</span>
  ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
  <span class="token keyword keyword-defer">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Server forced to shutdown”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Server exiting<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h1 id="%E5%8D%81%E4%B8%80%E3%80%81%E6%B5%8B%E8%AF%95">十一、測試</h1><p>編寫單元和集成測試是軟件開發的重要組成部分，在開始編寫測試相關之前需要確保一些基礎的應用問題，例如，主要要做的是創建測試數據庫。 這將通過使用已經創建的開發數據庫模式來完成。</p><p>我們將從創建新的測試配置開始。 將下面的函數添加到 <code>services/conf/conf.go</code>：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">NewTestConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Config <span class="token punctuation">{</span>
  testConfig <span class="token operator">:=</span> <span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  testConfig<span class="token punctuation">.</span>DbName <span class="token operator">=</span> testConfig<span class="token punctuation">.</span>DbName <span class="token operator">+</span> <span class="token string">"_test"</span>
  <span class="token keyword keyword-return">return</span> testConfig
<span class="token punctuation">}</span>
</code></pre><p>這將創建與通常配置相同的新配置，但將 <code>_test</code>後綴附加到數據庫名稱。 請參考之前添加數據庫的例子在數據庫中增加新的數據庫，測試數據庫將被命名為 <code>pharos_test</code>。</p><pre><code>DROP DATABASE IF EXISTS pharos_test;
CREATE DATABASE pharos_test WITH TEMPLATE pharos;
</code></pre><p>創建一個叫 <code>pharos_test</code> 的數據庫，每次更改開放數據庫時候都需要執行此操作。</p><p>每次測試用例都必須獨立於其他用例，因此我嗯應該為每次測試用例使用新的數據庫，所以，將在每個測試用例開始時創建和調用充值的數據庫函數，在這個函數中我們將重置所有表名，清除所有表，重置它的計數器，確保所有ID排序從 1 開始，我們可以將函數添加到 <code>services/store/store.go</code></p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">ResetTestDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Connect to test database</span>
  <span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">NewTestConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Empty all tables and restart sequence counters</span>
  tables <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>“users”<span class="token punctuation">,</span> “posts”<span class="token punctuation">}</span>
  <span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> table <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> tables <span class="token punctuation">{</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>“DELETE FROM <span class="token operator">%</span>s<span class="token punctuation">;</span>”<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Str</span><span class="token punctuation">(</span>“table”<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error clearing test database”<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>“ALTER SEQUENCE <span class="token operator">%</span>s_id_seq RESTART<span class="token punctuation">;</span>”<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>在大多數測試中我們需要做的一件事是設置測試環境並創建新用戶。 我們不想在每個測試用例中重復這一點。 讓我們創建文件 <code>services/store/main_test.go</code> 並添加輔助函數：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> store

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>conf”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
  gin<span class="token punctuation">.</span><span class="token function">SetMode</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>TestMode<span class="token punctuation">)</span>
  store<span class="token punctuation">.</span><span class="token function">ResetTestDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  cfg <span class="token operator">:=</span> conf<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span>“dev”<span class="token punctuation">)</span>
  <span class="token function">jwtSetup</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
  <span class="token keyword keyword-return">return</span> <span class="token function">setRouter</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">addTestUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
    Username<span class="token punctuation">:</span> “batman”<span class="token punctuation">,</span>
    Password<span class="token punctuation">:</span> “secret123”<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  err <span class="token operator">:=</span> <span class="token function">AddUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
  <span class="token keyword keyword-return">return</span> user<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><p>准備工作完成，現在我們可以開始添加測試了。 讓我們創建新文件 <code>services/store/users_test.go</code> 並創建第一個測試：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> store

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “testing”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>stretchr<span class="token operator">/</span>testify<span class="token operator">/</span>assert”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">TestAddUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">addTestUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NotEmpty</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Salt<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NotEmpty</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>HashedPassword<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>我們可以為用戶帳戶創建添加的另一個測試是當用戶嘗試使用現有用戶名創建帳戶時：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">TestAddUserWithExistingUsername</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">addTestUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>

  user<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">addTestUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> “Username already exists<span class="token punctuation">.</span>”<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>為了測試 <code>Authenticate()</code>函數，我們將創建 3 個測試：成功的身份驗證、使用無效用戶名進行身份驗證和使用無效密碼進行身份驗證：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">TestAuthenticateUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">addTestUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

  authUser<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Authenticate</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> authUser<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> authUser<span class="token punctuation">.</span>Username<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Salt<span class="token punctuation">,</span> authUser<span class="token punctuation">.</span>Salt<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>HashedPassword<span class="token punctuation">,</span> authUser<span class="token punctuation">.</span>HashedPassword<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> authUser<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">TestAuthenticateUserInvalidUsername</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">addTestUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

  authUser<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Authenticate</span><span class="token punctuation">(</span>“invalid”<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> authUser<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">TestAuthenticateUserInvalidPassword</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">addTestUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

  authUser<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Authenticate</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> “invalid”<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> authUser<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>最後，我們將使用 2 個測試來測試 <code>FetchUser()</code> 函數：成功獲取和獲取不存在的用戶：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">TestFetchUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  user<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">addTestUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

  fetchedUser<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">FetchUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> fetchedUser<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> fetchedUser<span class="token punctuation">.</span>Username<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> fetchedUser<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Salt<span class="token punctuation">,</span> fetchedUser<span class="token punctuation">.</span>Salt<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>HashedPassword<span class="token punctuation">,</span> fetchedUser<span class="token punctuation">.</span>HashedPassword<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">TestFetchNotExistingUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  fetchedUser<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">FetchUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> fetchedUser<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> “Not found<span class="token punctuation">.</span>”<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>上面的測試函數只測試數據庫通信，但我們的路由器和處理程序在這裡沒有測試。 為此，我們將需要另一組測試。 首先，我們應該創建更多的輔助函數。 我們將創建新文件 <code>services/server/main_test.go</code>：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"bytes"</span>
  <span class="token string">"encoding/json"</span>
  <span class="token string">"net/http"</span>
  <span class="token string">"net/http/httptest"</span>
  <span class="token string">"pharos/services/store"</span>
  <span class="token string">"strings"</span>

  <span class="token string">"<a class="vglnk" href="http://github.com/gin-gonic/gin" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>gin</span><span>-</span><span>gonic</span><span>/</span><span>gin</span></a>"</span>
  <span class="token string">"<a class="vglnk" href="http://github.com/rs/zerolog/log" rel="nofollow"><span>github</span><span>.</span><span>com</span><span>/</span><span>rs</span><span>/</span><span>zerolog</span><span>/</span><span>log</span></a>"</span>
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
  gin<span class="token punctuation">.</span><span class="token function">SetMode</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>TestMode<span class="token punctuation">)</span>
  store<span class="token punctuation">.</span><span class="token function">ResetTestDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">jwtSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-return">return</span> <span class="token function">setRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">userJSON</span><span class="token punctuation">(</span>user store<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  body<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span><span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword keyword-interface">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
    “Username”<span class="token punctuation">:</span> user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span>
    “Password”<span class="token punctuation">:</span> user<span class="token punctuation">.</span>Password<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error marshalling JSON body<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> <span class="token function">string</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">jsonRes</span><span class="token punctuation">(</span>body <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span> <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword keyword-interface">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
  jsonValue <span class="token operator">:=</span> <span class="token operator">&amp;</span><span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword keyword-interface">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jsonValue<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error unmarshalling JSON body<span class="token punctuation">.</span>”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> <span class="token operator">*</span>jsonValue
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">performRequest</span><span class="token punctuation">(</span>router <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">,</span> method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> body <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>httptest<span class="token punctuation">.</span>ResponseRecorder <span class="token punctuation">{</span>
  req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span>“Error creating <span class="token builtin">new</span> request”<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  rec <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>“Content<span class="token operator">-</span>Type”<span class="token punctuation">,</span> “application<span class="token operator">/</span>json”<span class="token punctuation">)</span>
  router<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
  <span class="token keyword keyword-return">return</span> rec
<span class="token punctuation">}</span>
</code></pre><p>除了最後一個，<code>performRequest()</code>，這些函數中的大多數都不是什麼新鮮事。 在該函數中，我們使用 http 包創建新請求，並使用 httptest 包創建新記錄器。 我們還需要將值為 <code>application/json</code> 的 <code>Content-Type</code> 標頭添加到我們的測試請求中。 我們現在准備使用傳遞的路由器來處理該測試請求，並使用記錄器記錄響應。 現在讓我們看看如何實際使用這些函數。 創建新文件 <code>services/server/user_test.go</code>：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  “net<span class="token operator">/</span>http”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”
  “testing”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>stretchr<span class="token operator">/</span>testify<span class="token operator">/</span>assert”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">TestSignUp</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  router <span class="token operator">:=</span> <span class="token function">testSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  body <span class="token operator">:=</span> <span class="token function">userJSON</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">{</span>
    Username<span class="token punctuation">:</span> “batman”<span class="token punctuation">,</span>
    Password<span class="token punctuation">:</span> “secret123”<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  rec <span class="token operator">:=</span> <span class="token function">performRequest</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> “POST”<span class="token punctuation">,</span> “<span class="token operator">/</span>api<span class="token operator">/</span>signup”<span class="token punctuation">,</span> body<span class="token punctuation">)</span>

  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> rec<span class="token punctuation">.</span>Code<span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> “Signed up successfully<span class="token punctuation">.</span>”<span class="token punctuation">,</span> <span class="token function">jsonRes</span><span class="token punctuation">(</span>rec<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">[</span>“msg”<span class="token punctuation">]</span><span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">NotEmpty</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">jsonRes</span><span class="token punctuation">(</span>rec<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">[</span>“jwt”<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>需要注意的是測試用例是按順序運行的，沒有並行性。 
如果同時運行，它們可能會相互影響，因為對於每個測試用例，數據庫都是空的。 如果您的機器有多個內核，Go 默認使用多個 goroutine 
來運行測試。 為了確保只使用了 1 個 goroutine，請添加 -p 1 選項。 這意味著您應該使用以下命令運行測試：</p><pre class=" language-bash"><code class=" language-bash">go test -p 1 ./internal/…
</code></pre><h1 id="%E5%8D%81%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2">十二、部署</h1><p>我
們的服務器已經完成，幾乎可以部署了，這將使用 Docker 完成。請注意，我說它幾乎准備好了，所以讓我們看看缺少什麼。一直以來，我們都使用 
React 開發服務器，它監聽 8181 端口並將所有請求重定向到我們的後端 8080 
端口。這對開發很有意義，因為它可以更輕松地同時開發前端和後端，以及調試前端反應應用程序。但是在生產中我們不需要它，只運行我們的後端服務器並將靜態
前端文件提供給客戶端更有意義。因此，我們不會使用 <code>npm start</code> 命令啟動 React 開發服務器，而是使用 <code>app/</code> 目錄中的命令 <code>npm run build</code> 為生產構建優化的前端文件。這將創建新目錄 app/build/ 以及生產所需的所有文件。現在我們還必須指示我們的後端在哪裡可以找到這些文件以便能夠為它們提供服務。這只需使用命令 <code>router.Use(static.Serve("/", static.LocalFile("./app/build", true)))</code> 即可完成。當然，我們希望只有在 prod 環境中啟動服務器時才這樣做，因此我們需要稍微更新一些文件。</p><p>首先，我們將更新 <code>services/cli/cli.go</code> 中的 Parse() 函數以將環境值作為字符串返回：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  flag<span class="token punctuation">.</span>Usage <span class="token operator">=</span> usage
  env <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>“env”<span class="token punctuation">,</span> “dev”<span class="token punctuation">,</span> <span class="token string">`Sets run environment. Possible values are "dev" and "prod"`</span><span class="token punctuation">)</span>
  flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  logging<span class="token punctuation">.</span><span class="token function">ConfigureLogger</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token operator">*</span>env <span class="token operator">==</span> “prod” <span class="token punctuation">{</span>
    logging<span class="token punctuation">.</span><span class="token function">SetGinLogToFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> <span class="token operator">*</span>env
<span class="token punctuation">}</span>
</code></pre><p>然後我們將更新 <code>Config struct NewConfig()</code> 函數以能夠接收和設置環境值：</p><pre class=" language-go"><code class=" language-go">pe Config <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
  Host       <span class="token builtin">string</span>
  Port       <span class="token builtin">string</span>
  DbHost     <span class="token builtin">string</span>
  DbPort     <span class="token builtin">string</span>
  DbName     <span class="token builtin">string</span>
  DbUser     <span class="token builtin">string</span>
  DbPassword <span class="token builtin">string</span>
  JwtSecret  <span class="token builtin">string</span>
  Env        <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token function">NewConfig</span><span class="token punctuation">(</span>env <span class="token builtin">string</span><span class="token punctuation">)</span> Config <span class="token punctuation">{</span>
  …
  <span class="token keyword keyword-return">return</span> Config<span class="token punctuation">{</span>
    Host<span class="token punctuation">:</span>       host<span class="token punctuation">,</span>
    Port<span class="token punctuation">:</span>       port<span class="token punctuation">,</span>
    DbHost<span class="token punctuation">:</span>     dbHost<span class="token punctuation">,</span>
    DbPort<span class="token punctuation">:</span>     dbPort<span class="token punctuation">,</span>
    DbName<span class="token punctuation">:</span>     dbName<span class="token punctuation">,</span>
    DbUser<span class="token punctuation">:</span>     dbUser<span class="token punctuation">,</span>
    DbPassword<span class="token punctuation">:</span> dbPassword<span class="token punctuation">,</span>
    JwtSecret<span class="token punctuation">:</span>  jwtSecret<span class="token punctuation">,</span>
    Env<span class="token punctuation">:</span>        env<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>現在我們可以更新 <code>services/cli/main.go </code>以接收來自 CLI 的 env 值，並將其發送到將用於啟動服務器的新配置創建：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-func">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  env <span class="token operator">:=</span> cli<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>接下來我們要做的是更新路由器以能夠接收配置參數，並將其設置為在生產模式下啟動時提供靜態文件：</p><pre class=" language-go"><code class=" language-go"><span class="token keyword keyword-package">package</span> server

<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
  <span class="token string">"net/http"</span>
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>conf”
  “pharos<span class="token operator">/</span>services<span class="token operator">/</span>store”

  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>contrib<span class="token operator">/</span>static”
  “github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin”
<span class="token punctuation">)</span>

<span class="token keyword keyword-func">func</span> <span class="token function">setRouter</span><span class="token punctuation">(</span>cfg conf<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Creates default gin router with Logger and Recovery middleware already attached</span>
  router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// Enables automatic redirection if the current route can’t be matched but a</span>
  <span class="token comment" spellcheck="true">// handler for the path with (without) the trailing slash exists.</span>
  router<span class="token punctuation">.</span>RedirectTrailingSlash <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment" spellcheck="true">// Serve static files to frontend if server is started in production environment</span>
  <span class="token keyword keyword-if">if</span> cfg<span class="token punctuation">.</span>Env <span class="token operator">==</span> “prod” <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>static<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>“<span class="token operator">/</span>“<span class="token punctuation">,</span> static<span class="token punctuation">.</span><span class="token function">LocalFile</span><span class="token punctuation">(</span>“<span class="token punctuation">.</span><span class="token operator">/</span>app<span class="token operator">/</span>build”<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// Create API route group</span>
  api <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>api”<span class="token punctuation">)</span>
  api<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>customErrors<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signup”<span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signUp<span class="token punctuation">)</span>
    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>signin”<span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signIn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  authorized <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>“<span class="token operator">/</span>“<span class="token punctuation">)</span>
  authorized<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    authorized<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> indexPosts<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>Post<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createPost<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts”<span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>Post<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> updatePost<span class="token punctuation">)</span>
    authorized<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span>“<span class="token operator">/</span>posts<span class="token operator">/</span><span class="token punctuation">:</span>id”<span class="token punctuation">,</span> deletePost<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  router<span class="token punctuation">.</span><span class="token function">NoRoute</span><span class="token punctuation">(</span><span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> router
<span class="token punctuation">}</span>
</code></pre><p>需要更新的最後一行在 <code>migrations/main.go</code> 文件中</p><pre class=" language-go"><code class=" language-go">store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>改為</p><pre class=" language-go"><code class=" language-go">store<span class="token punctuation">.</span><span class="token function">SetDBConnection</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token function">NewDBOptions</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span>“dev”<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>這還沒有完成。 您還必須更新所有使用配置和路由器設置的測試。</p><p>現在一切准備就緒，可以進行 Docker 部署。 Docker 不在本指南的范圍內，因此我不會詳細介紹 <code>Dockerfile</code>、<code>.dockerignore</code> 和 <code>docker-compose.yml</code> 內容。</p><p>首先我們將在項目根目錄中創建 &nbsp;<code>.dockerignore</code> 文件：</p><pre class=" language-bash"><code class=" language-bash"># This file
.dockerignore

# Git files
.git/
.gitignore

# VS Code config dir
.vscode/

# Docker configuration files
docker/

# Assets dependencies and built files
app/build/
app/node_modules/

# Log files
logs/

# Built binary
cmd/pharos/pharos

# ENV file
.env

# Readme file
README.md
</code></pre><p>現在用兩個文件 <code>Dockerfile</code> 和 <code>docker-compose.yml</code> 創建新目錄 <code>docker/</code>。 <code>Dockerfile</code> 的內容將是：</p><pre class=" language-bash"><code class=" language-bash">FROM node:16 AS frontendBuilder

# set app work dir
WORKDIR /pharos

# copy assets files to the container
COPY app/ .

# set app/ as work dir to build frontend static files
WORKDIR /pharos/app
RUN npm install
RUN npm run build

FROM golang:1.16.3 AS backendBuilder

# set app work dir
WORKDIR /go/src/pharos

# copy all files to the container
COPY . .

# build app executable
RUN CGO_ENABLED=0 GOOS=linux go build -o cmd/pharos/pharos cmd/pharos/main.go

# build migrations executable
RUN CGO_ENABLED=0 GOOS=linux go build -o migrations/migrations migrations/*.go

FROM alpine:3.14

# Create a group and user deploy
RUN addgroup -S deploy &amp;&amp; adduser -S deploy -G deploy

ARG ROOT_DIR=/home/deploy/pharos

WORKDIR ${ROOT_DIR}

RUN chown deploy:deploy ${ROOT_DIR}

# copy static assets file from frontend build
COPY —from=frontendBuilder —chown=deploy:deploy /pharos/build ./app/build

# copy app and migrations executables from backend builder
COPY —from=backendBuilder —chown=deploy:deploy /go/src/pharos/migrations/migrations ./migrations/
COPY —from=backendBuilder —chown=deploy:deploy /go/src/pharos/cmd/pharos/pharos .

# set user deploy as current user
USER deploy

# start app
CMD [ “./pharos”, “-env”, “prod” ]
</code></pre><p><code>docker-compose.yml</code> 的內容是：</p><pre class=" language-bash"><code class=" language-bash">version: “3”
services:
  pharos:
    image: kramat/pharos
    env_file:
      - ../.env
    environment:
      PHAROS_DB_HOST: db
    depends_on:
      - db
    ports:
      - ${PHAROS_PORT}:${PHAROS_PORT}
  db:
    image: postgres
    environment:
      POSTGRES_USER: ${PHAROS_DB_USER}
      POSTGRES_PASSWORD: ${PHAROS_DB_PASSWORD}
      POSTGRES_DB: ${PHAROS_DB_NAME}
    ports:
      - ${PHAROS_DB_PORT}:${PHAROS_DB_PORT}
    volumes:
      - postgresql:/var/lib/postgresql/pharos
      - postgresql_data:/var/lib/postgresql/pharos/data
volumes:
  postgresql: {}
  postgresql_data: {}
</code></pre><p>Docker 部署所需的所有文件現已准備就緒，讓我們看看如何構建 Docker 鏡像並部署它。 首先，我們將從官方 Docker 容器存儲庫中拉取 postgres 鏡像：</p><pre class=" language-bash"><code class=" language-bash">docker pull postgres
</code></pre><p>下一步是構建 pharos 鏡像。 在項目根目錄中運行（使用您自己的 docker ID 更改 DOCKER_ID）：</p><pre class=" language-bash"><code class=" language-bash">docker build -t DOCKER_ID/pharos -f docker/Dockerfile .
</code></pre><p>要使用資源創建 <code>pharos</code> 和 db 容器，請運行：</p><pre class=" language-bash"><code class=" language-bash">cd docker/
docker-compose up -d
</code></pre><p>這將啟動兩個容器，您可以通過運行 <code>docker ps</code> 檢查它們的狀態。 最後，我們需要運行遷移。 通過運行在 <code>pharos</code> 容器中打開 shell：</p><pre class=" language-bash"><code class=" language-bash">docker-compose run —rm pharos sh
</code></pre><p>在容器內部，我們可以像以前一樣運行遷移：</p><pre class=" language-bash"><code class=" language-bash">cd migrations/
./migrations init
./migrations up
</code></pre><p>我們已經完成了。 您可以在瀏覽器中打開 localhost:8181 以檢查一切是否正常，這意味著您應該能夠創建帳戶並添加新帖子：</p><p>要完善一個網站還有很多事情需要做，不僅僅是這些，以上的只是拋磚引玉。</p>
            <div class="social-sharing-bar">
	<a class="button share-facebook" target="_blank" title="Share over Facebook" href="https://www.facebook.com/sharer.php?u=https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/"><i class="fa fa-facebook"></i></a>

	<a class="button share-twitter" target="_blank" title="Share over Twitter" href="https://twitter.com/share?text=[%E5%8E%9F%E5%88%9B]%20%E4%BD%BF%E7%94%A8Golang%E3%80%81Gin%E5%92%8CReact%E3%80%81Esbuild%E5%BC%80%E5%8F%91%E5%92%8CDocker%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E7%AB%99%E5%BC%8FBlog&amp;url=https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/"><i class="fa fa-twitter"></i></a>

	<a class="button share-weibo" target="_blank" title="分享到微博" href="https://service.weibo.com/share/share.php?url=https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/&amp;title=[%E5%8E%9F%E5%88%9B]%20%E4%BD%BF%E7%94%A8Golang%E3%80%81Gin%E5%92%8CReact%E3%80%81Esbuild%E5%BC%80%E5%8F%91%E5%92%8CDocker%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E7%AB%99%E5%BC%8FBlog"><i class="fa fa-weibo"></i></a>

	<a class="button share-qq" target="_blank" title="分享到QQ" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.yuanliang.run/golan_gin_react_esbuild_blog_1/"><i class="fa fa-qq"></i></a>

	<button class="toggle-comments"><span>Comments</span> <i class="fa fa-comments-o"></i></button>
</div>
        </div>
	</article>
	
	

<article class="article-item" role="article" itemscope="" itemtype="//schema.org/Article">
   <div class="article-read-more-label">—You Might Enjoy—</div>
    <h1 class="article-item-headline" itemprop="headline">
        <a href="https://www.yuanliang.run/shijianguanli/" rel="bookmark">
            2022年我的時間管理計劃
        </a>
    </h1>

    <hr>

    <div class="article-item-body" itemprop="articleBody">
        1. 
要有意識的對時間進行管理只有當真正意識到自己是如何支配時間的，才能有效的管理時間。記錄自己一個星期內的時間日誌，觀察一下這個星期內的時間的支出情
況。看看哪些是可以重新分配的 2.要設定目標沒有目標就像大海漫無目的航行的船，永遠到不了想到的地方。要列舉出所有自己想要的目標。
    </div>

    <time class="article-item-time" datetime="2021-12-14" itemprop="datePublished">
        <strong>
             December 14,  2021
        </strong>
    </time>
</article>
</main>
<aside class="comments">
	<div class="container">
		<div id="disqus_thread"><iframe id="dsq-app549" name="dsq-app549" allowtransparency="true" scrolling="no" tabindex="0" title="Disqus" style="width: 1px !important; min-width: 100% !important; border: medium none !important; overflow: hidden !important; height: 393px !important;" src="ref_files/a_002.html" data-ruffle-polyfilled="" horizontalscrolling="no" verticalscrolling="no" width="100%" frameborder="0"></iframe></div>
		<script type="text/javascript">
		    /* * * CONFIGURATION VARIABLES * * */
		    var disqus_shortname = 'yuanliang';
		    var disqus_identifier = '';

		    /* * * DON'T EDIT BELOW THIS LINE * * */
		    (function() {
		        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		    })();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>
</aside>


    <script src="ref_files/jquery.js"></script>
    <script src="ref_files/pharos.js"></script>
    <script src="ref_files/code.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="ref_files/js"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108080181-1');
</script>


<iframe style="display: none;" data-ruffle-polyfilled=""></iframe></body><grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></html>